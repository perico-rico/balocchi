<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gemafusion - Enhanced PWA Game</title>
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1a202c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gemafusion">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <style>
    body {
      background-color: #1a202c;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 10px;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    .container {
      width: 95vw;
      max-width: 95vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .tile {
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(79, 209, 197, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 1;
    }
    .tile-text {
      position: absolute;
      bottom: 4px;
      right: 4px;
      z-index: 2;
      font-weight: bold;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.9);
      color: white;
      background: rgba(0,0,0,0.6);
      padding: 2px 6px;
      border-radius: 4px;
      backdrop-filter: blur(4px);
      transition: opacity 0.3s ease;
      font-size: 12px;
    }
    .tile-text.hidden {
      opacity: 0 !important;
      visibility: hidden !important;
    }
    .next-tile {
      width: 100px;
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      font-size: 24px;
      margin-bottom: 15px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #4fd1c5;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      box-shadow: 0 0 20px rgba(79, 209, 197, 0.4);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(79, 209, 197, 0.4); }
      50% { box-shadow: 0 0 30px rgba(79, 209, 197, 0.7); }
    }
    .tile.selected {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0, 255, 0, 0.8);
      z-index: 10;
      border-color: #00ff00;
    }
    .tile.merged {
      animation: merge 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes merge {
      0% { transform: scale(1); }
      30% { transform: scale(1.5) rotate(5deg); }
      60% { transform: scale(1.2) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    .main-game-area {
      display: flex;
      gap: 20px;
      width: 100%;
      max-width: 100%;
      margin: 20px 0;
      align-items: flex-start;
    }
    
    .game-board-container {
      flex: 1;
      display: flex;
      justify-content: flex-start;
    }
    
    .game-buttons-vertical {
      width: 80px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      flex-shrink: 0;
      align-items: center;
    }
    
    .btn-circular {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid rgba(79, 209, 197, 0.5);
      background: linear-gradient(135deg, #4a5568, #2d3748);
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
	
	.level-preview-section {
	  width: 100%;
	  margin: 15px 0;
	}

	.level-preview-horizontal {
	  display: flex;
	  justify-content: center;
	  gap: 15px;
	  flex-wrap: nowrap;
	  overflow-x: auto;
	  padding: 15px;
	  background: linear-gradient(135deg, #2d3748, #1a202c);
	  border: 2px solid rgba(79, 209, 197, 0.2);
	  border-radius: 12px;
	}

	.controls-row {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  width: 100%;
	  margin: 20px 0;
	  gap: 20px;
	}

	.controls-left {
	  display: flex;
	  gap: 10px;
	  flex-wrap: wrap;
	}

	.logo-section {
	  flex: 1;
	  text-align: center;
	}

	.logo-placeholder {
	  color: #4fd1c5;
	  font-size: 24px;
	  font-weight: bold;
	}

	.controls-right {
	  display: flex;
	  gap: 20px;
	  align-items: center;
	}

	.next-tile-container, .score-container {
	  text-align: center;
	}

	.game-board-section {
	  display: flex;
	  justify-content: center;
	  margin-top: 20px;
	}
    
    .btn-circular:hover {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 20px rgba(79, 209, 197, 0.4);
      border-color: #4fd1c5;
    }
    
    .btn-circular:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-circular.bonus {
      background: linear-gradient(135deg, #e53e3e, #c53030);
      border-color: rgba(229, 62, 62, 0.5);
    }
    
    .btn-circular.bonus:hover:not(:disabled) {
      background: linear-gradient(135deg, #c53030, #9c2626);
      border-color: #e53e3e;
    }
    
    .btn-counter {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #4fd1c5;
      color: #1a202c;
      font-size: 12px;
      font-weight: bold;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #1a202c;
    }
    
    #gameBoard {
      display: grid;
      gap: 20px;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 30px;
      border-radius: 20px;
      border: 2px solid rgba(79, 209, 197, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    #optionsScreen, #gameScreen {
      text-align: center;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #optionsScreen {
      display: flex;
    }
    #gameScreen {
      display: none;
    }
    #optionsScreen select, #optionsScreen input {
      margin: 10px;
      padding: 15px;
      font-size: 16px;
      width: 250px;
      border-radius: 12px;
      border: 2px solid #4fd1c5;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      color: white;
      transition: all 0.3s ease;
    }
    #optionsScreen select:focus, #optionsScreen input:focus {
      outline: none;
      box-shadow: 0 0 15px rgba(79, 209, 197, 0.5);
      transform: scale(1.02);
    }
    #optionsScreen button {
      padding: 15px 30px;
      font-size: 18px;
      background: linear-gradient(45deg, #4fd1c5, #38b2ac, #319795);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      margin: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(79, 209, 197, 0.3);
    }
    #optionsScreen button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(79, 209, 197, 0.5);
    }
    .game-header {
      display: grid;
      grid-template-columns: 2.5fr 100px 140px;
      grid-template-rows: 100px 70px;
      gap: 10px;
      width: 100%;
      max-width: 800px;
      margin: 20px 0;
    }
    
    .header-empty {
      grid-column: 1;
      grid-row: 1 / 3;
    }
    
    .header-next {
      grid-column: 2;
      grid-row: 1;
    }
    
    .header-level {
      grid-column: 2;
      grid-row: 2;
    }
    
    .header-score {
      grid-column: 3;
      grid-row: 1;
    }
    
    .header-record {
      grid-column: 3;
      grid-row: 2;
    }
    .game-controls {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .control-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #4a5568, #2d3748);
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid rgba(79, 209, 197, 0.3);
    }
    .control-btn:hover {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .control-btn.bonus {
      background: linear-gradient(135deg, #e53e3e, #c53030);
    }
    .control-btn.bonus:hover:not(:disabled) {
      background: linear-gradient(135deg, #c53030, #9c2626);
    }
    .loading-indicator {
      display: none;
      margin: 15px 0;
      color: #4fd1c5;
      font-weight: 500;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-top: 2px solid #4fd1c5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h1 {
      background: linear-gradient(45deg, #4fd1c5, #38b2ac, #319795);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.8rem;
      margin-bottom: 25px;
      text-shadow: 0 0 30px rgba(79, 209, 197, 0.3);
    }
    .instructions {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      border: 2px solid rgba(79, 209, 197, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    .level-preview-large {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 10px 0;
    }
    .preview-tile-large {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 2px solid rgba(79, 209, 197, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }
    .preview-tile-large:hover {
      transform: scale(1.1);
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      max-width: 400px;
      width: 90%;
    }
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .theme-option {
      padding: 15px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    .theme-option:hover, .theme-option.selected {
      border-color: #4fd1c5;
      background: rgba(79, 209, 197, 0.1);
    }
    .records-modal {
      max-width: 600px;
    }
    .records-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .records-table th,
    .records-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(79, 209, 197, 0.3);
    }
    .records-table th {
      background: rgba(79, 209, 197, 0.2);
    }
    .tile-chooser {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .tile-choice {
      width: 50px;
      height: 50px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      transition: all 0.3s ease;
    }
    .tile-choice:hover {
      border-color: #4fd1c5;
      transform: scale(1.1);
    }
    @media (max-width: 480px) {
      h1 { font-size: 2.2rem; }
      .game-stats { flex-direction: column; gap: 8px; }
      .stat-item { min-width: auto; }
      #optionsScreen select, #optionsScreen input { width: 200px; }
      .preview-tile { width: 25px; height: 25px; font-size: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="optionsScreen">
      <h1>üíé Gemafusion üíé</h1>
      <div class="instructions">
        <strong>üéÆ Instrucciones del Juego:</strong><br>
        ‚Ä¢ Toca dos fichas adyacentes del mismo nivel para fusionarlas<br>
        ‚Ä¢ Cada fusi√≥n aumenta el nivel y tu puntuaci√≥n<br>
        ‚Ä¢ ¬°Alcanza el nivel m√°ximo para ganar!<br>
        ‚Ä¢ Las fichas m√°s altas dan m√°s puntos
      </div>
      
      <label>üë§ Nombre del Jugador:</label><br>
      <input type="text" id="playerNick" placeholder="Ingresa tu nombre" value="Jugador"><br>
      
      <label>üìê Tama√±o del Tablero:</label><br>
      <select id="gridType">
        <option value="3x4">3x4 (Principiante)</option>
        <option value="4x5" selected>4x5 (Normal)</option>
        <option value="5x6">5x6 (Experto)</option>
      </select><br>
      
      <label>üéØ Nivel M√°ximo:</label><br>
      <select id="maxLevel">
        <option value="5">5 niveles (R√°pido)</option>
        <option value="7" selected>7 niveles (Normal)</option>
        <option value="10">10 niveles (Desaf√≠o)</option>
      </select><br>
      
      <label>üé® Tema Visual:</label><br>
      <select id="themeSelect">
        <option value="diamonds" selected>üíé Diamantes</option>
        <option value="frutas">üçé Frutas</option>
        <option value="frutas2">üçì Frutas 2</option>
        <option value="flores">üå∏ Flores</option>
        <option value="vegetales">ü•¨ Vegetales</option>
      </select><br>
      
      <button onclick="startGame()">üöÄ Comenzar Partida</button>
      <button onclick="showRecords()">üèÜ Ver R√©cords</button>
      <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        Cargando recursos del juego...
      </div>
      <p id="highScore" style="margin-top: 25px; font-size: 20px; font-weight: 500;">
        üèÜ R√©cord Personal: <span id="highScoreValue" style="color: #4fd1c5;">0</span>
      </p>
    </div>
	<div id="gameScreen">
     <!-- Secci√≥n 1: Preview de niveles (horizontal, arriba) -->
     <div class="level-preview-section">
       <div id="levelPreview" class="level-preview-horizontal"></div>
     </div>

     <!-- Secci√≥n 2: Fila horizontal con controles -->
     <div class="controls-row">
       <!-- Botones circulares (izquierda) -->
       <div class="controls-left">
         <button class="btn-circular" onclick="toggleNumbers()" title="Mostrar/Ocultar n√∫meros">üî¢</button>
         <button class="btn-circular bonus" id="bonusBtn" onclick="showBonusModal()" title="Cambiar pr√≥xima ficha">
           ‚≠ê
           <span class="btn-counter" id="bonusCount">3</span>
         </button>
         <button class="btn-circular bonus" id="undoBtn" onclick="undoMove()" title="Deshacer movimiento">
           ‚Ü∂
           <span class="btn-counter" id="undoCount">3</span>
         </button>
         <button class="btn-circular" onclick="restartGame()" title="Nueva partida">üîÑ</button>
         <button class="btn-circular" onclick="backToMenu()" title="Men√∫ principal">üè†</button>
         <button class="btn-circular" onclick="showRecords()" title="Ver r√©cords">üèÜ</button>
         <button class="btn-circular" onclick="exitGame()" title="Salir del juego">‚ùå</button>
       </div>

       <!-- Logo central -->
       <div class="logo-section">
         <div class="logo-placeholder">Gemafusion</div>
       </div>

       <!-- Pr√≥xima ficha y puntuaci√≥n (derecha) -->
       <div class="controls-right">
         <div class="next-tile-container">
           <div id="nextTile"></div>
           <div class="level-indicator" id="currentLevelDisplay">7</div>
         </div>
         <div class="score-container">
           <div class="score-main" id="score">0</div>
           <div class="score-record">
             <span class="record-label">A superar</span>
             <span class="record-value" id="recordToBeaten">-</span>
           </div>
         </div>
       </div>
     </div>

     <!-- Secci√≥n 3: Tablero de juego (centrado, m√°ximo tama√±o) -->
     <div class="game-board-section">
       <div id="gameBoard"></div>
     </div>
   </div>



  <!-- Modales -->
  <div id="themeModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>üé® Seleccionar Tema</h2>
      <div class="theme-grid">
        <div class="theme-option" data-theme="diamonds">
          <div>üíé</div>
          <div>Diamantes</div>
        </div>
        <div class="theme-option" data-theme="frutas">
          <div>üçé</div>
          <div>Frutas</div>
        </div>
        <div class="theme-option" data-theme="frutas2">
          <div>üçì</div>
          <div>Frutas 2</div>
        </div>
        <div class="theme-option" data-theme="flores">
          <div>üå∏</div>
          <div>Flores</div>
        </div>
        <div class="theme-option" data-theme="vegetales">
          <div>ü•¨</div>
          <div>Vegetales</div>
        </div>
      </div>
      <button class="control-btn" onclick="closeModal('themeModal')">Cerrar</button>
    </div>
  </div>

  <div id="bonusModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>‚≠ê Cambiar Pr√≥xima Ficha</h2>
      <p>Selecciona el nivel de ficha que quieres:</p>
      <div id="tileChooser" class="tile-chooser"></div>
      <button class="control-btn" onclick="closeModal('bonusModal')">Cancelar</button>
    </div>
  </div>

  <div id="recordsModal" class="modal" style="display: none;">
    <div class="modal-content records-modal">
      <h2>üèÜ R√©cords por Modalidad</h2>
      <div>
        <label>Modalidad: </label>
        <select id="recordsFilter" onchange="updateRecordsDisplay()">
          <option value="3x4_5">3x4 - 5 niveles</option>
          <option value="3x4_7">3x4 - 7 niveles</option>
          <option value="3x4_10">3x4 - 10 niveles</option>
          <option value="4x5_5">4x5 - 5 niveles</option>
          <option value="4x5_7" selected>4x5 - 7 niveles</option>
          <option value="4x5_10">4x5 - 10 niveles</option>
          <option value="5x6_5">5x6 - 5 niveles</option>
          <option value="5x6_7">5x6 - 7 niveles</option>
          <option value="5x6_10">5x6 - 10 niveles</option>
        </select>
      </div>
      <table class="records-table">
        <thead>
          <tr>
            <th>Pos</th>
            <th>Jugador</th>
            <th>Puntuaci√≥n</th>
            <th>Fichas Max</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
        </tbody>
      </table>
      <button class="control-btn" onclick="closeModal('recordsModal')">Cerrar</button>
    </div>
  </div>

  <script>
    // Variables globales del juego
    let boardSizeX = 4;
    let boardSizeY = 5;
    let board = [];
    let score = 0;
    let moves = 0;
    let selectedTile = null;
    let nextTileLevel = 0;
    let maxLevel = 7;
    let maxReachedLevel = 1;
    let playerNick = 'Jugador';
    let gameStartTime = 0;
    let showNumbers = true;
    let currentTheme = 'diamonds';
    let bonusesLeft = 3;
    let undosLeft = 3;
    let gameHistory = [];

    // Sistema de temas
    const THEMES = {
      diamonds: {
        name: 'Diamantes',
        folder: './images/diamonds/',
        prefix: 'd',
        available: true
      },
      frutas: {
        name: 'Frutas',
        folder: './images/frutas/',
        prefix: 'a',
        available: true
      },
      frutas2: {
        name: 'Frutas 2',
        folder: './images/frutas2/',
        prefix: 'b',
        available: true
      },
      flores: {
        name: 'Flores',
        folder: './images/flores/',
        prefix: 'f',
        available: true
      },
      vegetales: {
        name: 'Vegetales',
        folder: './images/vegeta/',
        prefix: 'v',
        available: true
      }
    };

    // URLs de im√°genes seg√∫n tema
    const TILE_IMAGES = {};

    // Sistema de audio
    const SOUNDS = {
      welcome: './sounds/welcome.mp3',
      merge: './sounds/merge.wav',
      levelup: './sounds/levelup.mp3',
      victory: './sounds/victory.wav',
      bonus: './sounds/bonus.wav',
      undo: './sounds/undo.wav'
    };

    // Funci√≥n para reproducir sonidos
    function playSound(soundName) {
      try {
        if (SOUNDS[soundName]) {
          const audio = new Audio(SOUNDS[soundName]);
          audio.volume = 0.5;
          audio.play().catch(e => console.log('Audio no disponible:', soundName));
        }
      } catch (e) {
        console.log('Error de audio:', e);
      }
    }

    // Generar URLs de im√°genes para tema actual
    function generateTileImages(theme) {
      const themeData = THEMES[theme];
      const images = {};
      
      for (let i = 0; i <= 9; i++) {
        const num = String(i + 1).padStart(2, '0');
        images[i] = `${themeData.folder}${themeData.prefix}${num}.png`;
      }
      
      return images;
    }

    // Obtener imagen para nivel espec√≠fico
    function getTileImage(level) {
      return TILE_IMAGES[Math.min(level, 9)] || TILE_IMAGES[0];
    }

    // Verificar reglas especiales de generaci√≥n
    function checkSpecialRules(presentLevels) {
      if (presentLevels.length === 0) return null;
      
      // Contar frecuencia de cada nivel
      const levelCounts = {};
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            const level = board[i][j].level;
            levelCounts[level] = (levelCounts[level] || 0) + 1;
          }
        }
      }
      
      const minLevel = Math.min(...presentLevels);
      const minLevelCount = levelCounts[minLevel] || 0;
      const totalTiles = Object.values(levelCounts).reduce((sum, count) => sum + count, 0);
      
      // Regla 1: Solo quedan 2 fichas del nivel m√≠nimo y el resto son superiores
      if (minLevelCount === 2 && totalTiles > 2) {
        const allOthersHigher = presentLevels.every(level => 
          level === minLevel || level > minLevel
        );
        
        if (allOthersHigher) {
          console.log(`üéØ Regla 1 activada: Solo 2 fichas de nivel ${minLevel}, generando nivel ${minLevel + 1}`);
          return { type: 'minLevel', level: minLevel + 1 };
        }
      }
      
      // Regla 2: Solo quedan 2 fichas adyacentes del mismo nivel y resto superiores
      for (const level of presentLevels) {
        if (levelCounts[level] === 2) {
          const adjacentPair = findAdjacentPairOfLevel(level);
          if (adjacentPair) {
            const allOthersHigher = presentLevels.every(l => 
              l === level || l > level
            );
            
            if (allOthersHigher) {
              console.log(`üéØ Regla 2 activada: Par adyacente de nivel ${level}, generando nivel ${level + 1}`);
              return { type: 'adjacentPair', level: level + 1 };
            }
          }
        }
      }
      
      return null;
    }
    
    // Buscar si existe un par adyacente de un nivel espec√≠fico
    function findAdjacentPairOfLevel(targetLevel) {
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j] && board[i][j].level === targetLevel) {
            // Verificar adyacentes
            const adjacents = [
              [i-1, j], [i+1, j], [i, j-1], [i, j+1]
            ];
            
            for (const [newI, newJ] of adjacents) {
              if (newI >= 0 && newI < boardSizeY && newJ >= 0 && newJ < boardSizeX) {
                if (board[newI][newJ] && board[newI][newJ].level === targetLevel) {
                  return { pos1: [i, j], pos2: [newI, newJ] };
                }
              }
            }
          }
        }
      }
      return null;
    }

    // Obtener niveles presentes en el tablero
    function getBoardLevels() {
      const levels = new Set();
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            levels.add(board[i][j].level);
          }
        }
      }
      return Array.from(levels).sort((a, b) => a - b);
    }

    // Generar pr√≥xima ficha con l√≥gica inteligente y reglas especiales
    function generateNextTileLevel() {
      const presentLevels = getBoardLevels();
      if (presentLevels.length === 0) {
        return 0; // Tablero vac√≠o, empezar con nivel 0
      }

      // Verificar reglas especiales primero
      const specialRule = checkSpecialRules(presentLevels);
      if (specialRule) {
        return Math.min(specialRule.level, maxLevel - 1);
      }

      // L√≥gica normal
      const minLevel = Math.min(...presentLevels);
      const maxPresentLevel = Math.max(...presentLevels);
      const maxValidLevel = Math.max(0, maxPresentLevel - 2);
      
      // Crear array de niveles v√°lidos (que existen en tablero)
      const validLevels = presentLevels.filter(level => level <= maxValidLevel);
      
      if (validLevels.length === 0) {
        return minLevel; // Fallback
      }

      // Sistema de probabilidades ponderadas (favorece niveles bajos)
      const weights = [];
      if (validLevels.length === 1) {
        weights.push(100);
      } else if (validLevels.length === 2) {
        weights.push(70, 30);
      } else if (validLevels.length === 3) {
        weights.push(50, 30, 20);
      } else if (validLevels.length === 4) {
        weights.push(40, 30, 20, 10);
      } else {
        weights.push(35, 25, 20, 15);
        for (let i = 4; i < validLevels.length; i++) {
          weights.push(5);
        }
      }

      // Selecci√≥n ponderada
      const totalWeight = weights.reduce((sum, w) => sum + w, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < validLevels.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          return validLevels[i];
        }
      }
      
      return validLevels[0]; // Fallback
    }

    // Actualizar preview de niveles (versi√≥n grande)
    function updateLevelPreview() {
      const preview = document.getElementById('levelPreview');
      preview.innerHTML = '';
      
      for (let i = 0; i < maxLevel; i++) {
        const tile = document.createElement('div');
        tile.className = 'preview-tile-large';
        tile.style.backgroundImage = `url('${getTileImage(i)}')`;
        tile.dataset.level = i; // Guardar nivel para toggle
        tile.textContent = showNumbers ? (i + 1) : '';
        preview.appendChild(tile);
      }
    }

    // Toggle mostrar/ocultar n√∫meros
    function toggleNumbers() {
      showNumbers = !showNumbers;
      
      console.log('üî¢ Toggle n√∫meros:', showNumbers ? 'MOSTRAR' : 'OCULTAR');
      
      // Aplicar a todas las fichas existentes del tablero
      const tileTexts = document.querySelectorAll('.tile-text');
      console.log('üìç Fichas encontradas:', tileTexts.length);
      
      tileTexts.forEach((text, index) => {
        if (showNumbers) {
          text.classList.remove('hidden');
        } else {
          text.classList.add('hidden');
        }
        console.log(`Ficha ${index}:`, text.classList.contains('hidden') ? 'OCULTA' : 'VISIBLE');
      });
      
      // Aplicar a preview de niveles
      document.querySelectorAll('.preview-tile-large').forEach(tile => {
        tile.textContent = showNumbers ? (tile.dataset.level ? parseInt(tile.dataset.level) + 1 : '') : '';
      });
      
      // Actualizar pr√≥xima ficha
      updateNextTile();
    }

    // Sistema de bonus - cambiar ficha
    function showBonusModal() {
      if (bonusesLeft <= 0) return;
      
      const modal = document.getElementById('bonusModal');
      const chooser = document.getElementById('tileChooser');
      chooser.innerHTML = '';
      
      // Mostrar opciones de fichas disponibles
      const presentLevels = getBoardLevels();
      const maxPresentLevel = Math.max(...presentLevels);
      const maxValidLevel = Math.max(0, maxPresentLevel - 2);
      
      for (let i = 0; i <= Math.min(maxValidLevel, maxLevel - 1); i++) {
        const tile = document.createElement('div');
        tile.className = 'tile-choice';
        tile.style.backgroundImage = `url('${getTileImage(i)}')`;
        tile.textContent = showNumbers ? (i + 1) : '';
        tile.onclick = () => useBonusChangeTitle(i);
        chooser.appendChild(tile);
      }
      
      modal.style.display = 'flex';
    }

    function useBonusChangeTitle(level) {
      nextTileLevel = level;
      bonusesLeft--;
      updateNextTile();
      updateBonusButtons();
      playSound('bonus');
      closeModal('bonusModal');
    }

    // Sistema de deshacer movimientos
    function saveGameState() {
      const state = {
        board: JSON.parse(JSON.stringify(board.map(row => 
          row.map(cell => cell ? { level: cell.level } : null)
        ))),
        score,
        moves,
        nextTileLevel,
        maxReachedLevel
      };
      
      gameHistory.push(state);
      if (gameHistory.length > 3) {
        gameHistory.shift();
      }
    }

    function undoMove() {
      if (undosLeft <= 0 || gameHistory.length === 0) return;
      
      const previousState = gameHistory.pop();
      undosLeft--;
      
      // Restaurar estado
      score = previousState.score;
      moves = previousState.moves;
      nextTileLevel = previousState.nextTileLevel;
      maxReachedLevel = previousState.maxReachedLevel;
      
      // Limpiar tablero actual
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      // Recrear tablero desde estado guardado
      board = Array(boardSizeY).fill().map(() => Array(boardSizeX).fill(null));
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (previousState.board[i][j]) {
            board[i][j] = {
              level: previousState.board[i][j].level,
              element: createTileElement(previousState.board[i][j].level, i, j)
            };
          }
        }
      }
      
      renderBoard();
      updateNextTile();
      updateStats();
      updateBonusButtons();
      playSound('undo');
    }

    function updateBonusButtons() {
      document.getElementById('bonusCount').textContent = bonusesLeft;
      document.getElementById('undoCount').textContent = undosLeft;
      document.getElementById('bonusBtn').disabled = bonusesLeft <= 0;
      document.getElementById('undoBtn').disabled = undosLeft <= 0;
      
      // Ocultar contador si es 0
      const bonusCounter = document.getElementById('bonusCount');
      const undoCounter = document.getElementById('undoCount');
      bonusCounter.style.display = bonusesLeft > 0 ? 'flex' : 'none';
      undoCounter.style.display = undosLeft > 0 ? 'flex' : 'none';
    }

    // Sistema de r√©cords por modalidad
    function getModalityKey() {
      return `${boardSizeX}x${boardSizeY}_${maxLevel}`;
    }

    function saveRecord() {
      const modalityKey = getModalityKey();
      const recordKey = `records_${modalityKey}`;
      
      // Contar fichas de nivel m√°ximo
      const maxLevelTiles = getBoardLevels().filter(level => level === maxLevel - 1).length;
      
      const newRecord = {
        player: playerNick,
        score: score,
        maxTiles: maxLevelTiles,
        date: new Date().toLocaleDateString(),
        timestamp: Date.now()
      };
      
      // Obtener r√©cords existentes
      let records = JSON.parse(localStorage.getItem(recordKey) || '[]');
      records.push(newRecord);
      
      // Ordenar por puntuaci√≥n y mantener top 5
      records.sort((a, b) => b.score - a.score);
      records = records.slice(0, 5);
      
      localStorage.setItem(recordKey, JSON.stringify(records));
    }

    function getRecords(modalityKey) {
      const recordKey = `records_${modalityKey}`;
      return JSON.parse(localStorage.getItem(recordKey) || '[]');
    }

    function showRecords() {
      const modal = document.getElementById('recordsModal');
      const filter = document.getElementById('recordsFilter');
      filter.value = getModalityKey();
      updateRecordsDisplay();
      modal.style.display = 'flex';
    }

    function updateRecordsDisplay() {
      const modalityKey = document.getElementById('recordsFilter').value;
      const records = getRecords(modalityKey);
      const tbody = document.getElementById('recordsTableBody');
      
      tbody.innerHTML = '';
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay r√©cords a√∫n</td></tr>';
        return;
      }
      
      records.forEach((record, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${record.player}</td>
          <td>${record.score.toLocaleString()}</td>
          <td>${record.maxTiles}</td>
          <td>${record.date}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Cerrar modales
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Salir del juego
    function exitGame() {
      if (confirm('¬øEst√°s seguro de que quieres salir del juego?')) {
        window.close();
      }
    }

    // Precargar im√°genes con mejor manejo de errores
    function preloadImages() {
      return new Promise((resolve, reject) => {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'flex';
        loadingIndicator.style.alignItems = 'center';
        
        // Generar URLs para tema actual
        Object.assign(TILE_IMAGES, generateTileImages(currentTheme));
        
        const imagePromises = Object.values(TILE_IMAGES).map(url => {
          return new Promise((resolveImg, rejectImg) => {
            const img = new Image();
            img.onload = () => resolveImg(url);
            img.onerror = () => {
              console.warn(`‚ö†Ô∏è No se pudo cargar: ${url}`);
              resolveImg(url); // Resolver en lugar de rechazar para continuar
            };
            img.src = url;
          });
        });

        Promise.all(imagePromises)
          .then(() => {
            loadingIndicator.style.display = 'none';
            console.log('‚úÖ Recursos cargados correctamente');
            resolve();
          })
          .catch(error => {
            loadingIndicator.style.display = 'none';
            console.error('‚ùå Error cargando recursos:', error);
            resolve(); // Continuar aunque algunas im√°genes fallen
          });
      });
    }

    // Inicializar tablero de juego
    function initBoard() {
      board = Array(boardSizeY).fill().map(() => Array(boardSizeX).fill(null));
      
      // Crear fichas iniciales con distribuci√≥n balanceada
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          const rand = Math.random();
          const randomLevel = rand < 0.7 ? 0 : rand < 0.9 ? 1 : 2;
          board[i][j] = { 
            level: randomLevel, 
            element: createTileElement(randomLevel, i, j) 
          };
        }
      }
      
      // Generar primera ficha siguiente
      nextTileLevel = generateNextTileLevel();
      
      renderBoard();
      updateNextTile();
      updateLevelPreview();
      updateStats();
      updateBonusButtons();
    }

    // Crear elemento de ficha mejorado con tama√±o din√°mico
    function createTileElement(level, row, col) {
      const tile = document.createElement('div');
      tile.className = `tile level-${level}`;
      tile.dataset.row = row;
      tile.dataset.col = col;
      tile.dataset.level = level;
      
      // Crear texto del nivel
      const tileText = document.createElement('div');
      tileText.className = 'tile-text';
      if (!showNumbers) {
        tileText.classList.add('hidden');
      }
      tileText.textContent = level + 1;
      tile.appendChild(tileText);
      
      // Aplicar imagen de fondo
      const imageUrl = getTileImage(level);
      tile.style.backgroundImage = `url('${imageUrl}')`;
      
      // El tama√±o se aplicar√° en renderBoard()
      // Por ahora usar tama√±o base
      tile.style.width = '100px';
      tile.style.height = '100px';
      
      // Eventos mejorados para m√≥vil y escritorio
      tile.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleTileClick(row, col);
      }, { passive: false });
      
      tile.addEventListener('click', (e) => {
        e.preventDefault();
        handleTileClick(row, col);
      });
      
      return tile;
    }

    // Actualizar ficha siguiente
    function updateNextTile() {
      const nextTileContainer = document.getElementById('nextTile');
      nextTileContainer.innerHTML = '';
      
      const tile = document.createElement('div');
      tile.className = 'next-tile';
      tile.textContent = showNumbers ? (nextTileLevel + 1) : '';
      tile.style.backgroundImage = `url('${getTileImage(nextTileLevel)}')`;
      
      nextTileContainer.appendChild(tile);
    }

    // Renderizar tablero completo con fichas m√°s grandes
    function renderBoard() {
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      // Calcular tama√±o de ficha m√°s grande aprovechando todo el espacio vertical
      const viewportHeight = window.innerHeight;
      const headerHeight = 300; // Aproximado para cajas 1-6
      const availableHeight = viewportHeight - headerHeight - 100; // Margen de seguridad
      
      // Calcular tama√±o √≥ptimo basado en altura disponible y n√∫mero de filas
      const maxTileSizeByHeight = Math.floor((availableHeight - 60) / boardSizeY) - 20; // 60 padding, 20 gap
      
      // Tambi√©n considerar ancho disponible (dejando espacio para botones)
      const viewportWidth = window.innerWidth;
      const availableWidth = viewportWidth * 0.75; // 75% del ancho (25% para botones y m√°rgenes)
      const maxTileSizeByWidth = Math.floor((availableWidth - 60) / boardSizeX) - 20;
      
      // Usar el menor de los dos para que quepa bien
      const optimalTileSize = Math.min(maxTileSizeByHeight, maxTileSizeByWidth);
      const finalTileSize = Math.max(80, Math.min(optimalTileSize, 150)); // Entre 80px y 150px
      
      gameBoard.style.gridTemplateColumns = `repeat(${boardSizeX}, ${finalTileSize}px)`;
      gameBoard.style.gridTemplateRows = `repeat(${boardSizeY}, ${finalTileSize}px)`;
      
      // Actualizar tama√±o de fichas existentes
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j] && board[i][j].element) {
            const tile = board[i][j].element;
            tile.style.width = `${finalTileSize}px`;
            tile.style.height = `${finalTileSize}px`;
            
            // Ajustar tama√±o del texto
            const tileText = tile.querySelector('.tile-text');
            if (tileText) {
              tileText.style.fontSize = `${Math.max(16, finalTileSize * 0.2)}px`;
            }
            
            gameBoard.appendChild(tile);
          }
        }
      }
      
      console.log(`üéØ Tablero renderizado: ${finalTileSize}px por ficha`);
    }

    // Manejar clic/toque en ficha
    function handleTileClick(row, col) {
      if (!board[row][col]) return;

      if (!selectedTile) {
        // Seleccionar ficha
        selectedTile = { row, col };
        board[row][col].element.classList.add('selected');
      } else {
        const { row: prevRow, col: prevCol } = selectedTile;
        board[prevRow][prevCol].element.classList.remove('selected');

        if (row === prevRow && col === prevCol) {
          // Deseleccionar la misma ficha
          selectedTile = null;
          return;
        }

        if (isAdjacent(row, col, prevRow, prevCol) && 
            board[row][col].level === board[prevRow][prevCol].level) {
          // Guardar estado antes del movimiento
          saveGameState();
          // Fusionar fichas
          mergeTiles(row, col, prevRow, prevCol);
          moves++;
        }
        
        selectedTile = null;
      }
    }

    // Verificar adyacencia
    function isAdjacent(row1, col1, row2, col2) {
      return (Math.abs(row1 - row2) === 1 && col1 === col2) || 
             (Math.abs(col1 - col2) === 1 && row1 === row2);
    }

    // Sistema de fusi√≥n mejorado con puntuaci√≥n exponencial
    function mergeTiles(row, col, prevRow, prevCol) {
      const level = board[row][col].level;
      
      if (level >= maxLevel - 1) return;

      // Sistema de puntuaci√≥n exponencial (favorece fusiones altas)
      const basePoints = Math.pow(2, level + 3) * 5; // M√°s puntos para niveles altos
      const levelBonus = (level + 1) * 15;
      const points = basePoints + levelBonus;
      score += points;

      // Crear nueva ficha fusionada
      const newLevel = level + 1;
      board[row][col] = { 
        level: newLevel, 
        element: createTileElement(newLevel, row, col) 
      };
	  // Remover clase merged de todas las fichas anteriores
	  document.querySelectorAll('.tile.merged').forEach(tile => tile.classList.remove('merged'));
	  // A√±adir clase merged solo a la nueva ficha fusionada


      board[row][col].element.classList.add('merged');
      
      // Actualizar nivel m√°ximo alcanzado
      if (newLevel + 1 > maxReachedLevel) {
        maxReachedLevel = newLevel + 1;
        playSound('levelup');
      } else {
        playSound('merge');
      }

      // Colocar nueva ficha en posici√≥n vac√≠a
      board[prevRow][prevCol] = { 
        level: nextTileLevel, 
        element: createTileElement(nextTileLevel, prevRow, prevCol) 
      };

      // Generar siguiente ficha con l√≥gica inteligente
      nextTileLevel = generateNextTileLevel();

      updateNextTile();
      renderBoard();
      updateStats();
      
      // Verificar condici√≥n de nivel m√°ximo (sin popup molesto)
      if (newLevel >= maxLevel - 1) {
        saveRecord();
        playSound('victory');
      }
    }

    // Obtener r√©cord a superar para la modalidad actual
    function getRecordToBeaten() {
      const modalityKey = getModalityKey();
      const records = getRecords(modalityKey);
      
      if (records.length === 0) return null;
      
      // Buscar el r√©cord m√°s bajo que sea superior a la puntuaci√≥n actual
      const betterRecords = records.filter(record => record.score > score);
      if (betterRecords.length === 0) return null;
      
      // Ordenar y tomar el m√°s bajo (m√°s f√°cil de superar)
      betterRecords.sort((a, b) => a.score - b.score);
      return betterRecords[0];
    }

    // Actualizar display del r√©cord a superar
    function updateRecordDisplay() {
      const recordElement = document.getElementById('recordToBeaten');
      const record = getRecordToBeaten();
      
      if (record) {
        recordElement.textContent = record.score.toLocaleString();
        recordElement.style.color = '#ffa500';
      } else {
        recordElement.textContent = '¬°Nuevo r√©cord!';
        recordElement.style.color = '#4fd1c5';
      }
    }

    // Actualizar display del nivel actual
    function updateLevelDisplay() {
      document.getElementById('currentLevelDisplay').textContent = maxLevel;
    }

    // Actualizar estad√≠sticas en pantalla
    function updateStats() {
      document.getElementById('score').textContent = score.toLocaleString();
      updateRecordDisplay();
    }

    // Sistema de guardado de r√©cords (actualizado)
    function saveHighScore() {
      const modalityKey = getModalityKey();
      const currentHighKey = `gemafusion-highscore-${modalityKey}`;
      const currentHigh = parseInt(localStorage.getItem(currentHighKey) || '0');
      
      if (score > currentHigh) {
        localStorage.setItem(currentHighKey, score.toString());
        localStorage.setItem(`gemafusion-highscore-player-${modalityKey}`, playerNick);
        updateHighScoreDisplay();
      }
      
      // Guardar en sistema de r√©cords
      saveRecord();
    }

    // Mostrar r√©cord actual
    function updateHighScoreDisplay() {
      const modalityKey = getModalityKey();
      const highScore = localStorage.getItem(`gemafusion-highscore-${modalityKey}`) || '0';
      document.getElementById('highScoreValue').textContent = parseInt(highScore).toLocaleString();
    }

    // Iniciar nueva partida
    async function startGame() {
      try {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'flex';
        
        // Configurar par√°metros del juego
        const gridType = document.getElementById('gridType').value;
        [boardSizeX, boardSizeY] = gridType.split('x').map(Number);
        maxLevel = parseInt(document.getElementById('maxLevel').value);
        playerNick = document.getElementById('playerNick').value.trim() || 'Jugador';
        currentTheme = document.getElementById('themeSelect').value;
        
        // Precargar recursos
        await preloadImages();
        
        // Resetear estado del juego
        score = 0;
        moves = 0;
        maxReachedLevel = 1;
        selectedTile = null;
        gameStartTime = Date.now();
        bonusesLeft = 3;
        undosLeft = 3;
        gameHistory = [];
        
        // Cambiar a pantalla de juego
        document.getElementById('optionsScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'flex';
        
        // Reproducir sonido de bienvenida
        setTimeout(() => playSound('welcome'), 500);
        
        // Inicializar tablero
        initBoard();
        updateLevelDisplay();
        
        console.log(`üéÆ Nueva partida iniciada - ${boardSizeX}x${boardSizeY}, Nivel m√°ximo: ${maxLevel}, Jugador: ${playerNick}, Tema: ${currentTheme}`);
      } catch (error) {
        console.error('Error al iniciar el juego:', error);
        alert('‚ùå Error al inicializar el juego. Por favor, verifica tu conexi√≥n a internet e int√©ntalo de nuevo.');
      }
    }

    // Reiniciar juego
    function restartGame() {
      if (confirm('¬øEst√°s seguro de que quieres reiniciar la partida actual?')) {
        saveHighScore();
        startGame();
      }
    }

    // Volver al men√∫ principal
    function backToMenu() {
      if (confirm('¬øVolver al men√∫ principal? Se perder√° el progreso actual.')) {
        saveHighScore();
        document.getElementById('gameScreen').style.display = 'none';
        document.getElementById('optionsScreen').style.display = 'flex';
        updateHighScoreDisplay();
      }
    }

    // Inicializaci√≥n al cargar la p√°gina
    window.addEventListener('load', () => {
      console.log('üéÆ Gemafusion PWA Enhanced cargado correctamente');
      updateHighScoreDisplay();
      
      // Configurar tema inicial
      Object.assign(TILE_IMAGES, generateTileImages(currentTheme));
      
      // Precargar im√°genes en segundo plano
      preloadImages().catch(error => {
        console.warn('Advertencia: Algunas im√°genes no se pudieron precargar:', error);
      });

      // Event listeners para modales
      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });
    });

    // Prevenir zoom en dispositivos m√≥viles
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });

    // Prevenir scroll bounce en iOS
    document.addEventListener('touchmove', function(event) {
      event.preventDefault();
    }, { passive: false });

    // Manejar cambios de orientaci√≥n
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (document.getElementById('gameScreen').style.display !== 'none') {
          renderBoard();
          updateLevelPreview();
        }
      }, 100);
    });

    // Optimizaci√≥n para rendimiento
    window.addEventListener('resize', debounce(() => {
      if (document.getElementById('gameScreen').style.display !== 'none') {
        renderBoard();
        updateLevelPreview();
      }
    }, 250));

    // Funci√≥n debounce para optimizar resize
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Probabilidades utilizadas en el sistema de generaci√≥n
    console.log('üìä Sistema de probabilidades implementado:');
    console.log('   ‚Ä¢ 1 nivel: 100%');
    console.log('   ‚Ä¢ 2 niveles: 70%, 30%');
    console.log('   ‚Ä¢ 3 niveles: 50%, 30%, 20%');
    console.log('   ‚Ä¢ 4 niveles: 40%, 30%, 20%, 10%');
    console.log('   ‚Ä¢ 5+ niveles: 35%, 25%, 20%, 15%, 5% cada uno');
  </script>
</body>
</html>