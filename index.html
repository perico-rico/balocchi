<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gemafusion - Enhanced PWA Game</title>
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1a202c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gemafusion">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <style>
    body {
      background-color: #1a202c;
      margin: 0;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 5px;
      box-sizing: border-box;
      overflow-x: hidden;
      min-height: 100vh;
    }
    
    .header-layout {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 15px;
      gap: 20px;
      height: 120px;
    }
    
    .left-space {
      flex: 1;
      min-width: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    
    .next-tile-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
    }
    
    .next-tile-label {
      color: #a0aec0;
      font-size: 12px;
      margin-bottom: 5px;
    }
    
    .score-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 140px;
    }
    
    .level-section {
      min-width: 120px;
      text-align: center;
    }
    
    .main-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      min-height: calc(100vh - 200px);
    }
    
    .game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .controls-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px 0;
      min-width: 60px;
    }
    
    .control-btn-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a5568, #2d3748);
      border: 2px solid rgba(79, 209, 197, 0.3);
      color: white;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .control-btn-circle:hover {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .control-btn-circle:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .control-btn-circle.bonus {
      background: linear-gradient(135deg, #e53e3e, #c53030);
    }
    
    .control-btn-circle.bonus:hover:not(:disabled) {
      background: linear-gradient(135deg, #c53030, #9c2626);
    }
    
    .current-score {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(79, 209, 197, 0.3);
      text-align: center;
    }
    
    .score-label {
      font-size: 12px;
      color: #a0aec0;
      margin-bottom: 5px;
    }
    
    .score-value {
      font-size: 24px;
      font-weight: bold;
      color: #4fd1c5;
    }
    
    .target-score {
      background: linear-gradient(135deg, #e53e3e, #c53030);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
    }
    
    .target-position {
      font-weight: bold;
      margin-bottom: 3px;
    }
    
    .target-points {
      color: #fed7d7;
    }
    
    .title-section {
      text-align: center;
      flex: 1;
    }
    
    h1 {
      background: linear-gradient(45deg, #4fd1c5, #38b2ac, #319795);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      margin: 0;
      text-shadow: 0 0 30px rgba(79, 209, 197, 0.3);
    }
    
    .level-section {
      min-width: 120px;
      text-align: center;
    }
    
    .max-level-display {
      background: linear-gradient(135deg, #805ad5, #6b46c1);
      padding: 20px;
      border-radius: 15px;
      border: 2px solid rgba(128, 90, 213, 0.5);
    }
    
    .level-label {
      font-size: 14px;
      color: #e9d8fd;
      margin-bottom: 8px;
    }
    
    .level-value {
      font-size: 3rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .next-tile-section {
      text-align: center;
      margin: 20px 0;
    }
    
    .next-tile-label {
      color: #a0aec0;
      font-size: 15px;
      margin-bottom: 8px;
    }
    
    .next-tile {
      width: 100px;
      height: 100px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      font-size: 24px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #4fd1c5;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      box-shadow: 0 0 20px rgba(79, 209, 197, 0.4);
      animation: pulse 2s infinite;
      position: relative;
    }
    
    .next-tile-number {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: bold;
      transition: opacity 0.3s ease;
    }
    
    .next-tile-number.hidden {
      opacity: 0;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(79, 209, 197, 0.4); }
      50% { box-shadow: 0 0 30px rgba(79, 209, 197, 0.7); }
    }
    
    .level-preview {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .preview-label {
      color: #a0aec0;
      font-size: 13px;
      margin-bottom: 5px;
      text-align: center;
    }
    
    .preview-tile {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 1px solid rgba(79, 209, 197, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      position: relative;
    }
    
    .preview-number {
      position: absolute;
      bottom: 1px;
      right: 1px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 1px 3px;
      border-radius: 2px;
      font-size: 8px;
      transition: opacity 0.3s ease;
    }
    
    .preview-number.hidden {
      opacity: 0;
    }
    
    .tile {
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(79, 209, 197, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .tile-text {
      position: absolute;
      bottom: 5px;
      right: 5px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 14px;
      transition: opacity 0.3s ease;
    }
    
    .tile-text.hidden {
      opacity: 0;
    }
    
    .tile.selected {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0, 255, 0, 0.8);
      z-index: 10;
      border-color: #00ff00;
    }
    
    .tile.merged {
      animation: merge 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes merge {
      0% { transform: scale(1); }
      30% { transform: scale(1.5) rotate(5deg); }
      60% { transform: scale(1.2) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    
    #gameBoard {
      display: grid;
      gap: 12px;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 20px;
      border-radius: 15px;
      margin: 15px 0;
      border: 2px solid rgba(79, 209, 197, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    #optionsScreen, #gameScreen {
      text-align: center;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    #optionsScreen {
      display: flex;
    }
    
    #gameScreen {
      display: none;
    }
    
    #optionsScreen select, #optionsScreen input {
      margin: 10px;
      padding: 15px;
      font-size: 16px;
      width: 250px;
      border-radius: 12px;
      border: 2px solid #4fd1c5;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      color: white;
      transition: all 0.3s ease;
    }
    
    #optionsScreen select:focus, #optionsScreen input:focus {
      outline: none;
      box-shadow: 0 0 15px rgba(79, 209, 197, 0.5);
      transform: scale(1.02);
    }
    
    #optionsScreen button {
      padding: 15px 30px;
      font-size: 18px;
      background: linear-gradient(45deg, #4fd1c5, #38b2ac, #319795);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      margin: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(79, 209, 197, 0.3);
    }
    
    #optionsScreen button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(79, 209, 197, 0.5);
    }
    
    .game-controls {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    
    .control-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #4a5568, #2d3748);
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid rgba(79, 209, 197, 0.3);
    }
    
    .control-btn:hover {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .control-btn.bonus {
      background: linear-gradient(135deg, #e53e3e, #c53030);
    }
    
    .control-btn.bonus:hover:not(:disabled) {
      background: linear-gradient(135deg, #c53030, #9c2626);
    }
    
    .instructions {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      border: 2px solid rgba(79, 209, 197, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      max-width: 400px;
      width: 90%;
    }
    
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .theme-option {
      padding: 15px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .theme-option:hover, .theme-option.selected {
      border-color: #4fd1c5;
      background: rgba(79, 209, 197, 0.1);
    }
    
    .records-modal {
      max-width: 600px;
    }
    
    .records-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    .records-table th,
    .records-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(79, 209, 197, 0.3);
    }
    
    .records-table th {
      background: rgba(79, 209, 197, 0.2);
    }
    
    .tile-chooser {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .tile-choice {
      width: 50px;
      height: 50px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .tile-choice:hover {
      border-color: #4fd1c5;
      transform: scale(1.1);
    }
    
    .tile-choice-number {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 1px 3px;
      border-radius: 2px;
      font-size: 10px;
    }
    
    .loading-indicator {
      display: none;
      margin: 15px 0;
      color: #4fd1c5;
      font-weight: 500;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-top: 2px solid #4fd1c5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .header-layout {
        flex-direction: column;
        height: auto;
        gap: 10px;
      }
      
      .left-space {
        display: none;
      }
      
      .score-section, .level-section, .next-tile-section {
        min-width: auto;
        width: 100%;
      }
      
      .level-value { font-size: 2rem; }
      .preview-tile { width: 50px; height: 50px; font-size: 12px; }
      
      .main-layout {
        flex-direction: column;
      }
      
      .controls-column {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
        order: 2;
      }
      
      .game-area {
        order: 1;
      }
    }
    
    /* Forzar orientación vertical en móviles */
    @media screen and (orientation: landscape) and (max-width: 768px) {
      body::before {
        content: "Por favor, gira tu dispositivo a posición vertical";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        font-size: 24px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="optionsScreen">
      <h1>💎 Gemafusion 💎</h1>
      <div class="instructions">
        <strong>🎮 Instrucciones del Juego:</strong><br>
        • Toca dos fichas adyacentes del mismo nivel para fusionarlas<br>
        • Cada fusión aumenta el nivel y tu puntuación<br>
        • ¡Alcanza el nivel máximo para ganar!<br>
        • Las fichas más altas dan más puntos
      </div>
      
      <label>👤 Nombre del Jugador:</label><br>
      <input type="text" id="playerNick" placeholder="Ingresa tu nombre" value="Jugador"><br>
      
      <label>📐 Tamaño del Tablero:</label><br>
      <select id="gridType">
        <option value="3x4">3x4 (Principiante)</option>
        <option value="4x5" selected>4x5 (Normal)</option>
        <option value="5x6">5x6 (Experto)</option>
      </select><br>
      
      <label>🎯 Nivel Máximo:</label><br>
      <select id="maxLevel">
        <option value="5">5 niveles (Rápido)</option>
        <option value="7" selected>7 niveles (Normal)</option>
        <option value="10">10 niveles (Desafío)</option>
      </select><br>
      
      <label>🎨 Tema Visual:</label><br>
      <select id="themeSelect">
        <option value="diamonds" selected>💎 Diamantes</option>
        <option value="frutas">🍎 Frutas</option>
        <option value="frutas2">🍓 Frutas 2</option>
        <option value="flores">🌸 Flores</option>
        <option value="vegetales">🥬 Vegetales</option>
      </select><br>
      
      <button onclick="startGame()">🚀 Comenzar Partida</button>
      <button onclick="showRecords()">🏆 Ver Récords</button>
      <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        Cargando recursos del juego...
      </div>
      <p id="highScore" style="margin-top: 25px; font-size: 20px; font-weight: 500;">
        🏆 Récord Personal: <span id="highScoreValue" style="color: #4fd1c5;">0</span>
      </p>
    </div>

    <div id="gameScreen">
      <div class="header-layout">
        <div class="left-space">
          <!-- Espacio reservado para futuro logo -->
        </div>
        
        <div class="next-tile-section">
          <div class="next-tile-label">Próxima Ficha:</div>
          <div id="nextTile"></div>
        </div>
        
        <div class="score-section">
          <div class="current-score">
            <div class="score-label">Puntuación Actual</div>
            <div class="score-value" id="score">0</div>
          </div>
          <div class="target-score" id="targetScore">
            <div class="target-position">5º Posición</div>
            <div class="target-points">Meta: 0 puntos</div>
          </div>
        </div>
        
        <div class="level-section">
          <div class="max-level-display">
            <div class="level-label">Nivel Máximo</div>
            <div class="level-value" id="maxLevelDisplay">7</div>
          </div>
        </div>
      </div>

      <div style="margin: 15px 0;">
        <div class="preview-label">Niveles Disponibles:</div>
        <div id="levelPreview" class="level-preview"></div>
      </div>

      <div class="main-layout">
        <div class="game-area">
          <div id="gameBoard"></div>
        </div>
        
        <div class="controls-column">
          <button class="control-btn-circle" onclick="toggleNumbers()" title="Mostrar/Ocultar números">
            🔢
          </button>
          <button class="control-btn-circle bonus" id="bonusBtn" onclick="showBonusModal()" title="Cambiar ficha">
            ⭐
          </button>
          <button class="control-btn-circle bonus" id="undoBtn" onclick="undoMove()" title="Deshacer">
            ↶
          </button>
          <button class="control-btn-circle" onclick="restartGame()" title="Nueva partida">
            🔄
          </button>
          <button class="control-btn-circle" onclick="backToMenu()" title="Menú principal">
            🏠
          </button>
          <button class="control-btn-circle" onclick="showRecords()" title="Ver récords">
            🏆
          </button>
          <button class="control-btn-circle" onclick="exitGame()" title="Salir">
            ❌
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modales -->
  <div id="bonusModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>⭐ Cambiar Próxima Ficha</h2>
      <p>Selecciona el nivel de ficha que quieres:</p>
      <div id="tileChooser" class="tile-chooser"></div>
      <button class="control-btn" onclick="closeModal('bonusModal')">Cancelar</button>
    </div>
  </div>

  <div id="recordsModal" class="modal" style="display: none;">
    <div class="modal-content records-modal">
      <h2>🏆 Récords por Modalidad</h2>
      <div>
        <label>Modalidad: </label>
        <select id="recordsFilter" onchange="updateRecordsDisplay()">
          <option value="3x4_5">3x4 - 5 niveles</option>
          <option value="3x4_7">3x4 - 7 niveles</option>
          <option value="3x4_10">3x4 - 10 niveles</option>
          <option value="4x5_5">4x5 - 5 niveles</option>
          <option value="4x5_7" selected>4x5 - 7 niveles</option>
          <option value="4x5_10">4x5 - 10 niveles</option>
          <option value="5x6_5">5x6 - 5 niveles</option>
          <option value="5x6_7">5x6 - 7 niveles</option>
          <option value="5x6_10">5x6 - 10 niveles</option>
        </select>
      </div>
      <table class="records-table">
        <thead>
          <tr>
            <th>Pos</th>
            <th>Jugador</th>
            <th>Puntuación</th>
            <th>Fichas Max</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
        </tbody>
      </table>
      <button class="control-btn" onclick="closeModal('recordsModal')">Cerrar</button>
    </div>
  </div>

  <script>
    // Variables globales del juego
    let boardSizeX = 4;
    let boardSizeY = 5;
    let board = [];
    let score = 0;
    let selectedTile = null;
    let nextTileLevel = 0;
    let maxLevel = 7;
    let playerNick = 'Jugador';
    let gameStartTime = 0;
    let showNumbers = true;
    let currentTheme = 'diamonds';
    let bonusesLeft = 3;
    let undosLeft = 3;
    let gameHistory = [];
    let currentTargetRecord = null;

    // Sistema de temas
    const THEMES = {
      diamonds: {
        name: 'Diamantes',
        folder: './images/diamonds/',
        prefix: 'd',
        available: true
      },
      frutas: {
        name: 'Frutas',
        folder: './images/frutas/',
        prefix: 'a',
        available: true
      },
      frutas2: {
        name: 'Frutas 2',
        folder: './images/frutas2/',
        prefix: 'b',
        available: true
      },
      flores: {
        name: 'Flores',
        folder: './images/flores/',
        prefix: 'f',
        available: true
      },
      vegetales: {
        name: 'Vegetales',
        folder: './images/vegeta/',
        prefix: 'v',
        available: true
      }
    };

    // URLs de imágenes según tema
    const TILE_IMAGES = {};

    // Sistema de audio
    const SOUNDS = {
      welcome: './sounds/welcome.mp3',
      merge: './sounds/merge.wav',
      levelup: './sounds/levelup.mp3',
      victory: './sounds/victory.wav',
      bonus: './sounds/bonus.wav',
      undo: './sounds/undo.wav'
    };

    // Función para reproducir sonidos
    function playSound(soundName) {
      try {
        if (SOUNDS[soundName]) {
          const audio = new Audio(SOUNDS[soundName]);
          audio.volume = 0.5;
          audio.play().catch(e => console.log('Audio no disponible:', soundName));
        }
      } catch (e) {
        console.log('Error de audio:', e);
      }
    }

    // Generar URLs de imágenes para tema actual
    function generateTileImages(theme) {
      const themeData = THEMES[theme];
      const images = {};
      
      for (let i = 0; i <= 9; i++) {
        const num = String(i + 1).padStart(2, '0');
        images[i] = `${themeData.folder}${themeData.prefix}${num}.png`;
      }
      
      return images;
    }

    // Obtener imagen para nivel específico
    function getTileImage(level) {
      return TILE_IMAGES[Math.min(level, 9)] || TILE_IMAGES[0];
    }

    // Obtener niveles presentes en el tablero
    function getBoardLevels() {
      const levels = new Set();
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            levels.add(board[i][j].level);
          }
        }
      }
      return Array.from(levels).sort((a, b) => a - b);
    }

    // Contar fichas por nivel
    function countTilesByLevel() {
      const counts = {};
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            const level = board[i][j].level;
            counts[level] = (counts[level] || 0) + 1;
          }
        }
      }
      return counts;
    }

    // Encontrar pares adyacentes del mismo nivel
    function findAdjacentPairs() {
      const pairs = [];
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            const level = board[i][j].level;
            // Comprobar adyacentes
            const adjacent = [
              [i-1, j], [i+1, j], [i, j-1], [i, j+1]
            ];
            
            for (let [ai, aj] of adjacent) {
              if (ai >= 0 && ai < boardSizeY && aj >= 0 && aj < boardSizeX && 
                  board[ai][aj] && board[ai][aj].level === level) {
                const pairKey = `${Math.min(i,ai)},${Math.min(j,aj)}-${Math.max(i,ai)},${Math.max(j,aj)}`;
                if (!pairs.find(p => p.key === pairKey)) {
                  pairs.push({
                    key: pairKey,
                    level: level,
                    positions: [[i,j], [ai,aj]]
                  });
                }
              }
            }
          }
        }
      }
      return pairs;
    }

    // Generar próxima ficha con lógica inteligente mejorada
    function generateNextTileLevel() {
      const presentLevels = getBoardLevels();
      const levelCounts = countTilesByLevel();
      const adjacentPairs = findAdjacentPairs();
      
      if (presentLevels.length === 0) {
        return 0; // Tablero vacío
      }

      const minLevel = Math.min(...presentLevels);
      const maxPresentLevel = Math.max(...presentLevels);
      const totalTiles = boardSizeX * boardSizeY;
      
      // Regla 1: Anti-bloqueo - Si solo quedan 2 fichas de un nivel bajo y todas las demás son superiores
      for (let level of presentLevels) {
        if (levelCounts[level] === 2) {
          const otherTilesCount = totalTiles - 2;
          const higherLevelTiles = Object.entries(levelCounts)
            .filter(([l, count]) => parseInt(l) > level)
            .reduce((sum, [l, count]) => sum + count, 0);
          
          if (higherLevelTiles === otherTilesCount) {
            // Solo quedan 2 fichas de este nivel, no generarlo más
            const validLevels = presentLevels.filter(l => l > level);
            if (validLevels.length > 0) {
              return Math.min(...validLevels);
            }
          }
        }
      }
      
      // Regla 2: Última combinación - Si solo hay un par adyacente de un nivel, la nueva será X+1
      const singlePairs = adjacentPairs.filter(pair => {
        return levelCounts[pair.level] === 2;
      });
      
      if (singlePairs.length === 1) {
        const targetLevel = Math.min(singlePairs[0].level + 1, maxLevel - 1);
        return targetLevel;
      }

      // Lógica normal con límites dinámicos
      const maxValidLevel = Math.max(0, maxPresentLevel - 2);
      const validLevels = presentLevels.filter(level => level <= maxValidLevel);
      
      if (validLevels.length === 0) {
        return minLevel;
      }

      // Sistema de probabilidades ponderadas
      const weights = [];
      if (validLevels.length === 1) {
        weights.push(100);
      } else if (validLevels.length === 2) {
        weights.push(70, 30);
      } else if (validLevels.length === 3) {
        weights.push(50, 30, 20);
      } else if (validLevels.length === 4) {
        weights.push(40, 30, 20, 10);
      } else {
        weights.push(35, 25, 20, 15);
        for (let i = 4; i < validLevels.length; i++) {
          weights.push(5);
        }
      }

      // Selección ponderada
      const totalWeight = weights.reduce((sum, w) => sum + w, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < validLevels.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          return validLevels[i];
        }
      }
      
      return validLevels[0];
    }

    // Actualizar display del récord objetivo
    function updateTargetScore() {
      const modalityKey = getModalityKey();
      const records = getRecords(modalityKey);
      
      if (records.length === 0) {
        currentTargetRecord = null;
        document.getElementById('targetScore').innerHTML = `
          <div class="target-position">Sin récords</div>
          <div class="target-points">¡Sé el primero!</div>
        `;
        return;
      }
      
      // Encontrar el récord más bajo que sea superior a la puntuación actual
      let targetRecord = null;
      for (let i = records.length - 1; i >= 0; i--) {
        if (records[i].score > score) {
          targetRecord = { ...records[i], position: i + 1 };
          break;
        }
      }
      
      if (!targetRecord) {
        // Ya superaste todos los récords
        document.getElementById('targetScore').innerHTML = `
          <div class="target-position">¡Nuevo Récord!</div>
          <div class="target-points">¡Increíble!</div>
        `;
      } else {
        const position = targetRecord.position === 1 ? '1º' : 
                        targetRecord.position === 2 ? '2º' : 
                        targetRecord.position === 3 ? '3º' : 
                        `${targetRecord.position}º`;
        
        document.getElementById('targetScore').innerHTML = `
          <div class="target-position">${position} Posición</div>
          <div class="target-points">Meta: ${targetRecord.score.toLocaleString()}</div>
        `;
      }
      
      currentTargetRecord = targetRecord;
    }

    // Actualizar preview de niveles
    function updateLevelPreview() {
      const preview = document.getElementById('levelPreview');
      preview.innerHTML = '';
      
      for (let i = 0; i < maxLevel; i++) {
        const tile = document.createElement('div');
        tile.className = 'preview-tile';
        tile.style.backgroundImage = `url('${getTileImage(i)}')`;
        
        const number = document.createElement('div');
        number.className = 'preview-number';
        if (!showNumbers) number.classList.add('hidden');
        number.textContent = i + 1;
        
        tile.appendChild(number);
        preview.appendChild(tile);
      }
    }

    // Toggle mostrar/ocultar números
    function toggleNumbers() {
      showNumbers = !showNumbers;
      const toggleText = document.getElementById('numbersToggleText');
      toggleText.textContent = showNumbers ? '🔢 Ocultar Números' : '🔢 Mostrar Números';
      
      // Aplicar a todas las fichas existentes
      document.querySelectorAll('.tile-text').forEach(text => {
        text.classList.toggle('hidden', !showNumbers);
      });
      
      // Aplicar a siguiente ficha
      document.querySelectorAll('.next-tile-number').forEach(number => {
        number.classList.toggle('hidden', !showNumbers);
      });
      
      // Aplicar a preview
      document.querySelectorAll('.preview-number').forEach(number => {
        number.classList.toggle('hidden', !showNumbers);
      });
    }

    // Sistema de bonus - cambiar ficha
    function showBonusModal() {
      if (bonusesLeft <= 0) return;
      
      const modal = document.getElementById('bonusModal');
      const chooser = document.getElementById('tileChooser');
      chooser.innerHTML = '';
      
      // Mostrar opciones de fichas disponibles
      const presentLevels = getBoardLevels();
      const maxPresentLevel = Math.max(...presentLevels);
      const maxValidLevel = Math.max(0, maxPresentLevel - 2);
      
      for (let i = 0; i <= Math.min(maxValidLevel, maxLevel - 1); i++) {
        const tile = document.createElement('div');
        tile.className = 'tile-choice';
        tile.style.backgroundImage = `url('${getTileImage(i)}')`;
        tile.onclick = () => useBonusChangeTitle(i);
        
        const number = document.createElement('div');
        number.className = 'tile-choice-number';
        number.textContent = i + 1;
        tile.appendChild(number);
        
        chooser.appendChild(tile);
      }
      
      modal.style.display = 'flex';
    }

    function useBonusChangeTitle(level) {
      nextTileLevel = level;
      bonusesLeft--;
      updateNextTile();
      updateBonusButtons();
      playSound('bonus');
      closeModal('bonusModal');
    }

    // Sistema de deshacer movimientos
    function saveGameState() {
      const state = {
        board: JSON.parse(JSON.stringify(board.map(row => 
          row.map(cell => cell ? { level: cell.level } : null)
        ))),
        score,
        nextTileLevel
      };
      
      gameHistory.push(state);
      if (gameHistory.length > 3) {
        gameHistory.shift();
      }
    }

    function undoMove() {
      if (undosLeft <= 0 || gameHistory.length === 0) return;
      
      const previousState = gameHistory.pop();
      undosLeft--;
      
      // Restaurar estado
      score = previousState.score;
      nextTileLevel = previousState.nextTileLevel;
      
      // Limpiar tablero actual
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      // Recrear tablero desde estado guardado
      board = Array(boardSizeY).fill().map(() => Array(boardSizeX).fill(null));
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (previousState.board[i][j]) {
            board[i][j] = {
              level: previousState.board[i][j].level,
              element: createTileElement(previousState.board[i][j].level, i, j)
            };
          }
        }
      }
      
      renderBoard();
      updateNextTile();
      updateStats();
      updateBonusButtons();
      playSound('undo');
    }

    function updateBonusButtons() {
      document.getElementById('bonusCount').textContent = bonusesLeft;
      document.getElementById('undoCount').textContent = undosLeft;
      document.getElementById('bonusBtn').disabled = bonusesLeft <= 0;
      document.getElementById('undoBtn').disabled = undosLeft <= 0;
    }

    // Sistema de récords por modalidad
    function getModalityKey() {
      return `${boardSizeX}x${boardSizeY}_${maxLevel}`;
    }

    function saveRecord() {
      const modalityKey = getModalityKey();
      const recordKey = `records_${modalityKey}`;
      
      // Contar fichas de nivel máximo
      const levelCounts = countTilesByLevel();
      const maxLevelTiles = levelCounts[maxLevel - 1] || 0;
      
      const newRecord = {
        player: playerNick,
        score: score,
        maxTiles: maxLevelTiles,
        date: new Date().toLocaleDateString(),
        timestamp: Date.now()
      };
      
      // Obtener récords existentes
      let records = JSON.parse(localStorage.getItem(recordKey) || '[]');
      records.push(newRecord);
      
      // Ordenar por puntuación y mantener top 5
      records.sort((a, b) => b.score - a.score);
      records = records.slice(0, 5);
      
      localStorage.setItem(recordKey, JSON.stringify(records));
    }

    function getRecords(modalityKey) {
      const recordKey = `records_${modalityKey}`;
      return JSON.parse(localStorage.getItem(recordKey) || '[]');
    }

    function showRecords() {
      const modal = document.getElementById('recordsModal');
      const filter = document.getElementById('recordsFilter');
      filter.value = getModalityKey();
      updateRecordsDisplay();
      modal.style.display = 'flex';
    }

    function updateRecordsDisplay() {
      const modalityKey = document.getElementById('recordsFilter').value;
      const records = getRecords(modalityKey);
      const tbody = document.getElementById('recordsTableBody');
      
      tbody.innerHTML = '';
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay récords aún</td></tr>';
        return;
      }
      
      records.forEach((record, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${record.player}</td>
          <td>${record.score.toLocaleString()}</td>
          <td>${record.maxTiles}</td>
          <td>${record.date}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Cerrar modales
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Salir del juego
    function exitGame() {
      if (confirm('¿Estás seguro de que quieres salir del juego?')) {
        window.close();
      }
    }

    // Precargar imágenes con manejo robusto de errores
    function preloadImages() {
      return new Promise((resolve) => {
        try {
          const loadingIndicator = document.getElementById('loadingIndicator');
          if (loadingIndicator) {
            loadingIndicator.style.display = 'flex';
            loadingIndicator.style.alignItems = 'center';
          }
          
          // Generar URLs para tema actual
          Object.assign(TILE_IMAGES, generateTileImages(currentTheme));
          
          console.log(`Precargando imágenes del tema: ${currentTheme}`);
          
          const imagePromises = Object.values(TILE_IMAGES).map(url => {
            return new Promise((resolveImg) => {
              const img = new Image();
              img.onload = () => {
                console.log(`✅ Cargada: ${url}`);
                resolveImg(url);
              };
              img.onerror = () => {
                console.warn(`⚠️ No se pudo cargar: ${url}`);
                resolveImg(url); // Resolver siempre para continuar
              };
              img.src = url;
              
              // Timeout de seguridad
              setTimeout(() => {
                console.warn(`⏰ Timeout para: ${url}`);
                resolveImg(url);
              }, 5000);
            });
          });

          Promise.all(imagePromises)
            .then(() => {
              if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
              }
              console.log('✅ Precarga de imágenes completada');
              resolve();
            })
            .catch((error) => {
              if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
              }
              console.warn('⚠️ Error en precarga de imágenes:', error);
              resolve(); // Resolver siempre para continuar el juego
            });
            
        } catch (error) {
          console.error('❌ Error crítico en preloadImages:', error);
          resolve(); // Resolver para permitir que el juego continúe
        }
      });
    }

    // Inicializar tablero de juego
    function initBoard() {
      board = Array(boardSizeY).fill().map(() => Array(boardSizeX).fill(null));
      
      // Crear fichas iniciales con distribución balanceada
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          const rand = Math.random();
          const randomLevel = rand < 0.7 ? 0 : rand < 0.9 ? 1 : 2;
          board[i][j] = { 
            level: randomLevel, 
            element: createTileElement(randomLevel, i, j) 
          };
        }
      }
      
      nextTileLevel = generateNextTileLevel();
      
      renderBoard();
      updateNextTile();
      updateLevelPreview();
      updateStats();
      updateBonusButtons();
    }

    // Crear elemento de ficha con tamaño dinámico
    function createTileElement(level, row, col) {
      const tile = document.createElement('div');
      tile.className = `tile level-${level}`;
      tile.dataset.row = row;
      tile.dataset.col = col;
      tile.dataset.level = level;
      
      // Aplicar imagen de fondo
      const imageUrl = getTileImage(level);
      tile.style.backgroundImage = `url('${imageUrl}')`;
      
      // Crear texto del nivel (abajo derecha)
      const tileText = document.createElement('div');
      tileText.className = 'tile-text';
      if (!showNumbers) tileText.classList.add('hidden');
      tileText.textContent = level + 1;
      tile.appendChild(tileText);
      
      // El tamaño se aplicará dinámicamente en renderBoard()
      
      // Eventos para móvil y escritorio
      tile.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleTileClick(row, col);
      }, { passive: false });
      
      tile.addEventListener('click', (e) => {
        e.preventDefault();
        handleTileClick(row, col);
      });
      
      return tile;
    }

    // Actualizar ficha siguiente
    function updateNextTile() {
      const nextTileContainer = document.getElementById('nextTile');
      nextTileContainer.innerHTML = '';
      
      const tile = document.createElement('div');
      tile.className = 'next-tile';
      tile.style.backgroundImage = `url('${getTileImage(nextTileLevel)}')`;
      
      const number = document.createElement('div');
      number.className = 'next-tile-number';
      if (!showNumbers) number.classList.add('hidden');
      number.textContent = nextTileLevel + 1;
      
      tile.appendChild(number);
      nextTileContainer.appendChild(tile);
    }

    // Renderizar tablero completo con tamaño expandido
    function renderBoard() {
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      // Calcular tamaño máximo aprovechando el espacio disponible
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Espacio disponible: ancho total menos controles (80px) y márgenes
      const availableWidth = viewportWidth - 120;
      // Altura disponible: total menos header (140px) y preview (80px) y márgenes
      const availableHeight = viewportHeight - 250;
      
      // Calcular tamaño de celda basado en limitaciones
      const maxTileSizeByWidth = Math.floor((availableWidth - 60) / boardSizeX) - 12;
      const maxTileSizeByHeight = Math.floor((availableHeight - 60) / boardSizeY) - 12;
      
      // Usar el menor de los dos para que quepa todo
      const tileSize = Math.max(80, Math.min(maxTileSizeByWidth, maxTileSizeByHeight, 150));
      
      gameBoard.style.gridTemplateColumns = `repeat(${boardSizeX}, ${tileSize}px)`;
      gameBoard.style.gridTemplateRows = `repeat(${boardSizeY}, ${tileSize}px)`;
      
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j] && board[i][j].element) {
            // Actualizar tamaño de las fichas existentes
            board[i][j].element.style.width = `${tileSize}px`;
            board[i][j].element.style.height = `${tileSize}px`;
            gameBoard.appendChild(board[i][j].element);
          }
        }
      }
    }

    // Manejar clic/toque en ficha
    function handleTileClick(row, col) {
      if (!board[row][col]) return;

      if (!selectedTile) {
        selectedTile = { row, col };
        board[row][col].element.classList.add('selected');
      } else {
        const { row: prevRow, col: prevCol } = selectedTile;
        board[prevRow][prevCol].element.classList.remove('selected');

        if (row === prevRow && col === prevCol) {
          selectedTile = null;
          return;
        }

        if (isAdjacent(row, col, prevRow, prevCol) && 
            board[row][col].level === board[prevRow][prevCol].level) {
          saveGameState();
          mergeTiles(row, col, prevRow, prevCol);
        }
        
        selectedTile = null;
      }
    }

    // Verificar adyacencia
    function isAdjacent(row1, col1, row2, col2) {
      return (Math.abs(row1 - row2) === 1 && col1 === col2) || 
             (Math.abs(col1 - col2) === 1 && row1 === row2);
    }

    // Sistema de fusión mejorado
    function mergeTiles(row, col, prevRow, prevCol) {
      const level = board[row][col].level;
      
      if (level >= maxLevel - 1) return;

      // Sistema de puntuación exponencial
      const basePoints = Math.pow(2, level + 3) * 5;
      const levelBonus = (level + 1) * 15;
      const points = basePoints + levelBonus;
      score += points;

      // Crear nueva ficha fusionada
      const newLevel = level + 1;
      board[row][col] = { 
        level: newLevel, 
        element: createTileElement(newLevel, row, col) 
      };
      board[row][col].element.classList.add('merged');
      
      playSound(newLevel >= maxLevel - 1 ? 'victory' : 'merge');

      // Colocar nueva ficha en posición vacía
      board[prevRow][prevCol] = { 
        level: nextTileLevel, 
        element: createTileElement(nextTileLevel, prevRow, prevCol) 
      };

      // Generar siguiente ficha
      nextTileLevel = generateNextTileLevel();

      updateNextTile();
      renderBoard();
      updateStats();
      
      // Guardar récord sin popup molesto
      if (newLevel >= maxLevel - 1) {
        saveRecord();
      }
    }

    // Actualizar estadísticas
    function updateStats() {
      document.getElementById('score').textContent = score.toLocaleString();
      updateTargetScore();
    }

    // Sistema de guardado de récords
    function saveHighScore() {
      const modalityKey = getModalityKey();
      const currentHighKey = `gemafusion-highscore-${modalityKey}`;
      const currentHigh = parseInt(localStorage.getItem(currentHighKey) || '0');
      
      if (score > currentHigh) {
        localStorage.setItem(currentHighKey, score.toString());
        localStorage.setItem(`gemafusion-highscore-player-${modalityKey}`, playerNick);
        updateHighScoreDisplay();
      }
      
      saveRecord();
    }

    // Mostrar récord actual
    function updateHighScoreDisplay() {
      const modalityKey = getModalityKey();
      const highScore = localStorage.getItem(`gemafusion-highscore-${modalityKey}`) || '0';
      document.getElementById('highScoreValue').textContent = parseInt(highScore).toLocaleString();
    }

    // Iniciar nueva partida
    async function startGame() {
      try {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'flex';
        
        // Configurar parámetros del juego
        const gridType = document.getElementById('gridType').value;
        [boardSizeX, boardSizeY] = gridType.split('x').map(Number);
        maxLevel = parseInt(document.getElementById('maxLevel').value);
        playerNick = document.getElementById('playerNick').value.trim() || 'Jugador';
        currentTheme = document.getElementById('themeSelect').value;
        
        await preloadImages();
        
        // Resetear estado del juego
        score = 0;
        selectedTile = null;
        gameStartTime = Date.now();
        bonusesLeft = 3;
        undosLeft = 3;
        gameHistory = [];
        
        // Actualizar display del nivel máximo
        document.getElementById('maxLevelDisplay').textContent = maxLevel;
        
        // Cambiar a pantalla de juego
        document.getElementById('optionsScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'flex';
        
        setTimeout(() => playSound('welcome'), 500);
        
        initBoard();
        
        console.log(`🎮 Nueva partida - ${boardSizeX}x${boardSizeY}, Max: ${maxLevel}, Tema: ${currentTheme}`);
      } catch (error) {
        console.error('Error al iniciar el juego:', error);
        alert('❌ Error al inicializar el juego.');
      }
    }

    // Reiniciar juego
    function restartGame() {
      if (confirm('¿Reiniciar partida actual?')) {
        saveHighScore();
        startGame();
      }
    }

    // Volver al menú principal
    function backToMenu() {
      if (confirm('¿Volver al menú? Se perderá el progreso.')) {
        saveHighScore();
        document.getElementById('gameScreen').style.display = 'none';
        document.getElementById('optionsScreen').style.display = 'flex';
        updateHighScoreDisplay();
      }
    }

    // Inicialización
    window.addEventListener('load', () => {
      console.log('🎮 Gemafusion Enhanced cargado');
      updateHighScoreDisplay();
      Object.assign(TILE_IMAGES, generateTileImages(currentTheme));
      
      preloadImages().catch(error => {
        console.warn('Advertencia: Algunas imágenes no se pudieron precargar:', error);
      });

      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });
    });

    // Prevenir zoom y scroll en móviles
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });

    document.addEventListener('touchmove', function(event) {
      event.preventDefault();
    }, { passive: false });

    // Manejar cambios de orientación
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (document.getElementById('gameScreen').style.display !== 'none') {
          renderBoard();
          updateLevelPreview();
        }
      }, 100);
    });

    // Optimización para resize
    window.addEventListener('resize', debounce(() => {
      if (document.getElementById('gameScreen').style.display !== 'none') {
        renderBoard();
        updateLevelPreview();
      }
    }, 250));

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Probabilidades del sistema (para referencia)
    console.log('📊 Sistema de probabilidades:');
    console.log('   • 2 niveles: 70%, 30%');
    console.log('   • 3 niveles: 50%, 30%, 20%');
    console.log('   • 4 niveles: 40%, 30%, 20%, 10%');
    console.log('   • 5+ niveles: 35%, 25%, 20%, 15%, 5% resto');
    console.log('🧠 Reglas especiales:');
    console.log('   • Anti-bloqueo: No genera nivel si solo quedan 2 fichas');
    console.log('   • Última combinación: Genera nivel X+1 para último par');
  </script>
</body>
</html>