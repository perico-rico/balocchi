<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gemafusion - Enhanced PWA Game</title>
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1a202c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gemafusion">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <style>
    body {
      background-color: #1a202c;
      margin: 0;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 10px;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    .container {
      width: 100vw;
      max-width: 100vw;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .tile {
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(79, 209, 197, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 1;
    }
    .tile-text {
      position: relative;
      z-index: 2;
      font-weight: bold;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.9);
      color: white;
      background: rgba(0,0,0,0.4);
      padding: 4px 8px;
      border-radius: 8px;
      backdrop-filter: blur(4px);
      transition: opacity 0.3s ease;
    }
    .tile-text.hidden {
      opacity: 0;
    }
    .next-tile {
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      font-size: 18px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #4fd1c5;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      box-shadow: 0 0 20px rgba(79, 209, 197, 0.4);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(79, 209, 197, 0.4); }
      50% { box-shadow: 0 0 30px rgba(79, 209, 197, 0.7); }
    }
    .tile.selected {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0, 255, 0, 0.8);
      z-index: 10;
      border-color: #00ff00;
    }
    .tile.merged {
      animation: merge 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes merge {
      0% { transform: scale(1); }
      30% { transform: scale(1.5) rotate(5deg); }
      60% { transform: scale(1.2) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    #gameBoard {
      display: grid;
      gap: 8px;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 15px;
      border-radius: 20px;
      border: 2px solid rgba(79, 209, 197, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    #optionsScreen, #gameScreen {
      width: 100%;
    }
    #optionsScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 100vh;
    }
    #gameScreen {
      display: none;
      height: 100vh;
      overflow: hidden;
    }
    #optionsScreen select, #optionsScreen input {
      margin: 10px;
      padding: 15px;
      font-size: 16px;
      width: 250px;
      border-radius: 12px;
      border: 2px solid #4fd1c5;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      color: white;
      transition: all 0.3s ease;
    }
    #optionsScreen select:focus, #optionsScreen input:focus {
      outline: none;
      box-shadow: 0 0 15px rgba(79, 209, 197, 0.5);
      transform: scale(1.02);
    }
    #optionsScreen button {
      padding: 15px 30px;
      font-size: 18px;
      background: linear-gradient(45deg, #4fd1c5, #38b2ac, #319795);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      margin: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(79, 209, 197, 0.3);
    }
    #optionsScreen button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(79, 209, 197, 0.5);
    }
    .game-layout {
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto 1fr;
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }
    .info-bar {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .info-card {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(79, 209, 197, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      flex: 1;
      text-align: center;
    }
    .info-label {
      font-size: 12px;
      color: #a0aec0;
      margin-bottom: 5px;
    }
    .info-value {
      font-size: 18px;
      font-weight: bold;
      color: #4fd1c5;
    }
    .game-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .controls-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      width: 80px;
    }
    .control-section {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .next-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .level-display {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #2d3748, #1a202c);
      border: 3px solid #4fd1c5;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(79, 209, 197, 0.4);
    }
    .level-number {
      font-size: 48px;
      font-weight: bold;
      color: #4fd1c5;
      text-shadow: 0 0 10px #4fd1c5;
    }
    .level-text {
      font-size: 12px;
      color: #a0aec0;
      margin-top: 5px;
    }
    .level-preview {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .preview-tile {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 2px solid rgba(79, 209, 197, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      transition: all 0.3s ease;
    }
    .preview-tile:hover {
      transform: scale(1.1);
      border-color: #4fd1c5;
    }
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a5568, #2d3748);
      border: none;
      color: white;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      border: 2px solid rgba(79, 209, 197, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px 0;
    }
    .control-btn:hover {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .control-btn.bonus {
      background: linear-gradient(135deg, #e53e3e, #c53030);
    }
    .control-btn.bonus:hover:not(:disabled) {
      background: linear-gradient(135deg, #c53030, #9c2626);
    }
    .loading-indicator {
      display: none;
      margin: 15px 0;
      color: #4fd1c5;
      font-weight: 500;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-top: 2px solid #4fd1c5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h1 {
      background: linear-gradient(45deg, #4fd1c5, #38b2ac, #319795);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.8rem;
      margin-bottom: 25px;
      text-shadow: 0 0 30px rgba(79, 209, 197, 0.3);
    }
    .instructions {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      border: 2px solid rgba(79, 209, 197, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: linear-gradient(135deg, #2d3748, #1a202c);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      max-width: 400px;
      width: 90%;
    }
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .theme-option {
      padding: 15px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    .theme-option:hover, .theme-option.selected {
      border-color: #4fd1c5;
      background: rgba(79, 209, 197, 0.1);
    }
    .records-modal {
      max-width: 600px;
    }
    .records-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .records-table th,
    .records-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(79, 209, 197, 0.3);
    }
    .records-table th {
      background: rgba(79, 209, 197, 0.2);
    }
    .tile-chooser {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .tile-choice {
      width: 50px;
      height: 50px;
      border: 2px solid rgba(79, 209, 197, 0.3);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      transition: all 0.3s ease;
    }
    .tile-choice:hover {
      border-color: #4fd1c5;
      transform: scale(1.1);
    }
    .bonus-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #e53e3e;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      .game-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto 1fr;
      }
      .controls-area {
        flex-direction: row;
        width: 100%;
        justify-content: center;
      }
      .preview-tile { width: 40px; height: 40px; font-size: 12px; }
      .level-display { width: 80px; height: 80px; }
      .level-number { font-size: 32px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="optionsScreen">
      <h1>üíé Gemafusion üíé</h1>
      <div class="instructions">
        <strong>üéÆ Instrucciones del Juego:</strong><br>
        ‚Ä¢ Toca dos fichas adyacentes del mismo nivel para fusionarlas<br>
        ‚Ä¢ Cada fusi√≥n aumenta el nivel y tu puntuaci√≥n<br>
        ‚Ä¢ ¬°Alcanza el nivel m√°ximo para ganar!<br>
        ‚Ä¢ Las fichas m√°s altas dan m√°s puntos
      </div>
      
      <label>üë§ Nombre del Jugador:</label><br>
      <input type="text" id="playerNick" placeholder="Ingresa tu nombre" value="Jugador"><br>
      
      <label>üìê Tama√±o del Tablero:</label><br>
      <select id="gridType">
        <option value="3x4">3x4 (Principiante)</option>
        <option value="4x5" selected>4x5 (Normal)</option>
        <option value="5x6">5x6 (Experto)</option>
      </select><br>
      
      <label>üéØ Nivel M√°ximo:</label><br>
      <select id="maxLevel">
        <option value="5">5 niveles (R√°pido)</option>
        <option value="7" selected>7 niveles (Normal)</option>
        <option value="10">10 niveles (Desaf√≠o)</option>
      </select><br>
      
      <label>üé® Tema Visual:</label><br>
      <select id="themeSelect">
        <option value="diamonds" selected>üíé Diamantes</option>
        <option value="frutas">üçé Frutas</option>
        <option value="frutas2">üçì Frutas 2</option>
        <option value="flores">üå∏ Flores</option>
        <option value="vegetales">ü•¨ Vegetales</option>
      </select><br>
      
      <button onclick="startGame()">üöÄ Comenzar Partida</button>
      <button onclick="showRecords()">üèÜ Ver R√©cords</button>
      <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        Cargando recursos del juego...
      </div>
      <p id="highScore" style="margin-top: 25px; font-size: 20px; font-weight: 500;">
        üèÜ R√©cord Personal: <span id="highScoreValue" style="color: #4fd1c5;">0</span>
      </p>
    </div>

    <div id="gameScreen">
      <div class="game-layout">
        <div class="info-bar">
          <div class="info-card">
            <div class="info-label">Puntuaci√≥n Actual</div>
            <div class="info-value" id="score">0</div>
          </div>
          <div class="info-card">
            <div class="info-label">Siguiente R√©cord</div>
            <div class="info-value" id="nextRecord">--</div>
          </div>
        </div>
        
        <div class="game-area">
          <div class="control-section">
            <div class="next-section">
              <div style="color: #a0aec0; font-size: 12px;">Pr√≥xima:</div>
              <div id="nextTile"></div>
            </div>
            
            <div class="info-card" style="width: 80px; height: 80px; display: flex; flex-direction: column; justify-content: center;">
              <div class="info-label">Puntuaci√≥n</div>
              <div class="info-value" style="font-size: 14px;" id="scoreSmall">0</div>
            </div>
            
            <div class="info-card" style="width: 80px; height: 80px; display: flex; flex-direction: column; justify-content: center;">
              <div class="info-label">R√©cord</div>
              <div class="info-value" style="font-size: 14px;" id="recordSmall">--</div>
            </div>
            
            <div class="level-display">
              <div class="level-number" id="levelNumber">7</div>
              <div class="level-text">Nivel M√°x</div>
            </div>
          </div>

          <div style="margin: 10px 0;">
            <div style="color: #a0aec0; font-size: 13px; margin-bottom: 5px; text-align: center;">Niveles Disponibles:</div>
            <div id="levelPreview" class="level-preview"></div>
          </div>

          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div id="gameBoard"></div>
            
            <div class="controls-area">
              <button class="control-btn" onclick="toggleNumbers()" title="Mostrar/Ocultar N√∫meros">
                üî¢
              </button>
              <div style="position: relative;">
                <button class="control-btn bonus" id="bonusBtn" onclick="showBonusModal()" title="Cambiar Ficha">
                  ‚≠ê
                </button>
                <div class="bonus-count" id="bonusCount">3</div>
              </div>
              <div style="position: relative;">
                <button class="control-btn bonus" id="undoBtn" onclick="undoMove()" title="Deshacer">
                  ‚Ü∂
                </button>
                <div class="bonus-count" id="undoCount">3</div>
              </div>
              <button class="control-btn" onclick="restartGame()" title="Nueva Partida">
                üîÑ
              </button>
              <button class="control-btn" onclick="backToMenu()" title="Men√∫ Principal">
                üè†
              </button>
              <button class="control-btn" onclick="showRecords()" title="R√©cords">
                üèÜ
              </button>
              <button class="control-btn" onclick="exitGame()" title="Salir">
                ‚ùå
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modales -->
  <div id="bonusModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>‚≠ê Cambiar Pr√≥xima Ficha</h2>
      <p>Selecciona el nivel de ficha que quieres:</p>
      <div id="tileChooser" class="tile-chooser"></div>
      <button class="control-btn" onclick="closeModal('bonusModal')">Cancelar</button>
    </div>
  </div>

  <div id="recordsModal" class="modal" style="display: none;">
    <div class="modal-content records-modal">
      <h2>üèÜ R√©cords por Modalidad</h2>
      <div>
        <label>Modalidad: </label>
        <select id="recordsFilter" onchange="updateRecordsDisplay()">
          <option value="3x4_5">3x4 - 5 niveles</option>
          <option value="3x4_7">3x4 - 7 niveles</option>
          <option value="3x4_10">3x4 - 10 niveles</option>
          <option value="4x5_5">4x5 - 5 niveles</option>
          <option value="4x5_7" selected>4x5 - 7 niveles</option>
          <option value="4x5_10">4x5 - 10 niveles</option>
          <option value="5x6_5">5x6 - 5 niveles</option>
          <option value="5x6_7">5x6 - 7 niveles</option>
          <option value="5x6_10">5x6 - 10 niveles</option>
        </select>
      </div>
      <table class="records-table">
        <thead>
          <tr>
            <th>Pos</th>
            <th>Jugador</th>
            <th>Puntuaci√≥n</th>
            <th>Fichas Max</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
        </tbody>
      </table>
      <button class="control-btn" onclick="closeModal('recordsModal')">Cerrar</button>
    </div>
  </div>

  <script>
    // Variables globales del juego
    let boardSizeX = 4;
    let boardSizeY = 5;
    let board = [];
    let score = 0;
    let selectedTile = null;
    let nextTileLevel = 0;
    let maxLevel = 7;
    let playerNick = 'Jugador';
    let gameStartTime = 0;
    let showNumbers = true;
    let currentTheme = 'diamonds';
    let bonusesLeft = 3;
    let undosLeft = 3;
    let gameHistory = [];

    // Sistema de temas
    const THEMES = {
      diamonds: {
        name: 'Diamantes',
        folder: './images/diamonds/',
        prefix: 'd',
        available: true
      },
      frutas: {
        name: 'Frutas',
        folder: './images/frutas/',
        prefix: 'a',
        available: true
      },
      frutas2: {
        name: 'Frutas 2',
        folder: './images/frutas2/',
        prefix: 'b',
        available: true
      },
      flores: {
        name: 'Flores',
        folder: './images/flores/',
        prefix: 'f',
        available: true
      },
      vegetales: {
        name: 'Vegetales',
        folder: './images/vegeta/',
        prefix: 'v',
        available: true
      }
    };

    // URLs de im√°genes seg√∫n tema
    const TILE_IMAGES = {};

    // Sistema de audio
    const SOUNDS = {
      welcome: './sounds/welcome.mp3',
      merge: './sounds/merge.wav',
      levelup: './sounds/levelup.mp3',
      victory: './sounds/victory.wav',
      bonus: './sounds/bonus.wav',
      undo: './sounds/undo.wav'
    };

    // Funci√≥n para reproducir sonidos
    function playSound(soundName) {
      try {
        if (SOUNDS[soundName]) {
          const audio = new Audio(SOUNDS[soundName]);
          audio.volume = 0.5;
          audio.play().catch(e => console.log('Audio no disponible:', soundName));
        }
      } catch (e) {
        console.log('Error de audio:', e);
      }
    }

    // Generar URLs de im√°genes para tema actual
    function generateTileImages(theme) {
      const themeData = THEMES[theme];
      const images = {};
      
      for (let i = 0; i <= 9; i++) {
        const num = String(i + 1).padStart(2, '0');
        images[i] = `${themeData.folder}${themeData.prefix}${num}.png`;
      }
      
      return images;
    }

    // Obtener imagen para nivel espec√≠fico
    function getTileImage(level) {
      return TILE_IMAGES[Math.min(level, 9)] || TILE_IMAGES[0];
    }

    // Obtener niveles presentes en el tablero
    function getBoardLevels() {
      const levels = new Set();
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            levels.add(board[i][j].level);
          }
        }
      }
      return Array.from(levels).sort((a, b) => a - b);
    }

    // Contar fichas por nivel
    function getLevelCounts() {
      const counts = {};
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j]) {
            const level = board[i][j].level;
            counts[level] = (counts[level] || 0) + 1;
          }
        }
      }
      return counts;
    }

    // Verificar si hay solo 2 fichas adyacentes del mismo nivel
    function getOnlyTwoAdjacentPairs() {
      const levelCounts = getLevelCounts();
      const presentLevels = Object.keys(levelCounts).map(Number);
      
      for (const level of presentLevels) {
        if (levelCounts[level] === 2) {
          // Verificar si son adyacentes
          const positions = [];
          for (let i = 0; i < boardSizeY; i++) {
            for (let j = 0; j < boardSizeX; j++) {
              if (board[i][j] && board[i][j].level === level) {
                positions.push({row: i, col: j});
              }
            }
          }
          
          if (positions.length === 2) {
            const [pos1, pos2] = positions;
            if (isAdjacent(pos1.row, pos1.col, pos2.row, pos2.col)) {
              // Verificar si todas las dem√°s fichas son de nivel superior
              const otherLevels = presentLevels.filter(l => l !== level);
              const allHigher = otherLevels.every(l => l > level);
              
              if (allHigher) {
                return level; // Este nivel necesita fusi√≥n de rescate
              }
            }
          }
        }
      }
      return null;
    }

    // Verificar regla de liberaci√≥n por mayor√≠a
    function checkMajorityRule() {
      const levelCounts = getLevelCounts();
      const presentLevels = Object.keys(levelCounts).map(Number).sort((a, b) => a - b);
      
      if (presentLevels.length === 0) return null;
      
      const minLevel = presentLevels[0];
      const minCount = levelCounts[minLevel];
      
      // Si solo hay 2 fichas del nivel m√≠nimo
      if (minCount === 2) {
        // Verificar si todas las dem√°s son de nivel superior
        const otherLevels = presentLevels.filter(l => l !== minLevel);
        const allHigher = otherLevels.every(l => l > minLevel);
        
        if (allHigher) {
          return minLevel; // Ya no ofrecer este nivel m√≠nimo
        }
      }
      
      return null;
    }

    // Generar pr√≥xima ficha con l√≥gica inteligente y reglas avanzadas
    function generateNextTileLevel() {
      const presentLevels = getBoardLevels();
      if (presentLevels.length === 0) {
        return 0; // Tablero vac√≠o, empezar con nivel 0
      }

      // Verificar regla de fusi√≥n de rescate
      const rescueLevel = getOnlyTwoAdjacentPairs();
      if (rescueLevel !== null) {
        return rescueLevel + 1; // Ofrecer nivel superior para continuar jugando
      }

      // Verificar regla de liberaci√≥n por mayor√≠a
      const blockedLevel = checkMajorityRule();
      
      const minLevel = Math.min(...presentLevels);
      const maxPresentLevel = Math.max(...presentLevels);
      const maxValidLevel = Math.max(0, maxPresentLevel - 2);
      
      // Crear array de niveles v√°lidos
      let validLevels;
      
      if (blockedLevel !== null) {
        // Aplicar regla de liberaci√≥n: no ofrecer nivel bloqueado, ofrecer superiores
        validLevels = presentLevels.filter(level => level > blockedLevel && level <= maxValidLevel);
        // Si no hay v√°lidos superiores, ofrecer uno por encima del m√≠nimo
        if (validLevels.length === 0) {
          validLevels = [minLevel + 1].filter(level => level <= maxValidLevel);
        }
      } else {
        // L√≥gica normal: solo niveles que existen en tablero
        validLevels = presentLevels.filter(level => level <= maxValidLevel);
      }
      
      if (validLevels.length === 0) {
        return minLevel; // Fallback
      }

      // Sistema de probabilidades ponderadas (favorece niveles bajos)
      const weights = [];
      if (validLevels.length === 1) {
        weights.push(100);
      } else if (validLevels.length === 2) {
        weights.push(70, 30);
      } else if (validLevels.length === 3) {
        weights.push(50, 30, 20);
      } else if (validLevels.length === 4) {
        weights.push(40, 30, 20, 10);
      } else {
        weights.push(35, 25, 20, 15);
        for (let i = 4; i < validLevels.length; i++) {
          weights.push(5);
        }
      }

      // Selecci√≥n ponderada
      const totalWeight = weights.reduce((sum, w) => sum + w, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < validLevels.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          return validLevels[i];
        }
      }
      
      return validLevels[0]; // Fallback
    }

    // Actualizar preview de niveles
    function updateLevelPreview() {
      const preview = document.getElementById('levelPreview');
      preview.innerHTML = '';
      
      for (let i = 0; i < maxLevel; i++) {
        const tile = document.createElement('div');
        tile.className = 'preview-tile';
        tile.style.backgroundImage = `url('${getTileImage(i)}')`;
        tile.textContent = showNumbers ? (i + 1) : '';
        preview.appendChild(tile);
      }
    }

    // Actualizar display de nivel m√°ximo
    function updateLevelDisplay() {
      document.getElementById('levelNumber').textContent = maxLevel;
    }

    // Actualizar informaci√≥n de r√©cords
    function updateRecordInfo() {
      const modalityKey = getModalityKey();
      const records = getRecords(modalityKey);
      
      // Encontrar el siguiente r√©cord por encima de la puntuaci√≥n actual
      const nextRecord = records.find(record => record.score > score);
      const nextRecordText = nextRecord ? nextRecord.score.toLocaleString() : '¬°Nuevo r√©cord!';
      
      document.getElementById('nextRecord').textContent = nextRecordText;
      document.getElementById('recordSmall').textContent = nextRecordText;
    }

    // Toggle mostrar/ocultar n√∫meros
    function toggleNumbers() {
      showNumbers = !showNumbers;
      
      // Aplicar a todas las fichas existentes
      document.querySelectorAll('.tile-text').forEach(text => {
        text.classList.toggle('hidden', !showNumbers);
      });
      
      // Aplicar a siguiente ficha
      const nextTileElement = document.querySelector('.next-tile');
      if (nextTileElement) {
        nextTileElement.style.color = showNumbers ? 'white' : 'transparent';
      }
      
      // Actualizar preview
      updateLevelPreview();
    }

    // Sistema de bonus - cambiar ficha
    function showBonusModal() {
      if (bonusesLeft <= 0) return;
      
      const modal = document.getElementById('bonusModal');
      const chooser = document.getElementById('tileChooser');
      chooser.innerHTML = '';
      
      // Mostrar opciones de fichas disponibles
      const presentLevels = getBoardLevels();
      const maxPresentLevel = Math.max(...presentLevels);
      const maxValidLevel = Math.max(0, maxPresentLevel - 2);
      
      for (let i = 0; i <= Math.min(maxValidLevel, maxLevel - 1); i++) {
        const tile = document.createElement('div');
        tile.className = 'tile-choice';
        tile.style.backgroundImage = `url('${getTileImage(i)}')`;
        tile.textContent = showNumbers ? (i + 1) : '';
        tile.onclick = () => useBonusChangeTitle(i);
        chooser.appendChild(tile);
      }
      
      modal.style.display = 'flex';
    }

    function useBonusChangeTitle(level) {
      nextTileLevel = level;
      bonusesLeft--;
      updateNextTile();
      updateBonusButtons();
      playSound('bonus');
      closeModal('bonusModal');
    }

    // Sistema de deshacer movimientos
    function saveGameState() {
      const state = {
        board: JSON.parse(JSON.stringify(board.map(row => 
          row.map(cell => cell ? { level: cell.level } : null)
        ))),
        score,
        nextTileLevel
      };
      
      gameHistory.push(state);
      if (gameHistory.length > 3) {
        gameHistory.shift();
      }
    }

    function undoMove() {
      if (undosLeft <= 0 || gameHistory.length === 0) return;
      
      const previousState = gameHistory.pop();
      undosLeft--;
      
      // Restaurar estado
      score = previousState.score;
      nextTileLevel = previousState.nextTileLevel;
      
      // Limpiar tablero actual
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      // Recrear tablero desde estado guardado
      board = Array(boardSizeY).fill().map(() => Array(boardSizeX).fill(null));
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (previousState.board[i][j]) {
            board[i][j] = {
              level: previousState.board[i][j].level,
              element: createTileElement(previousState.board[i][j].level, i, j)
            };
          }
        }
      }
      
      renderBoard();
      updateNextTile();
      updateStats();
      updateBonusButtons();
      playSound('undo');
    }

    function updateBonusButtons() {
      document.getElementById('bonusCount').textContent = bonusesLeft;
      document.getElementById('undoCount').textContent = undosLeft;
      document.getElementById('bonusBtn').disabled = bonusesLeft <= 0;
      document.getElementById('undoBtn').disabled = undosLeft <= 0;
    }

    // Sistema de r√©cords por modalidad
    function getModalityKey() {
      return `${boardSizeX}x${boardSizeY}_${maxLevel}`;
    }

    function saveRecord() {
      const modalityKey = getModalityKey();
      const recordKey = `records_${modalityKey}`;
      
      // Contar fichas de nivel m√°ximo
      const maxLevelTiles = getBoardLevels().filter(level => level === maxLevel - 1).length;
      
      const newRecord = {
        player: playerNick,
        score: score,
        maxTiles: maxLevelTiles,
        date: new Date().toLocaleDateString(),
        timestamp: Date.now()
      };
      
      // Obtener r√©cords existentes
      let records = JSON.parse(localStorage.getItem(recordKey) || '[]');
      records.push(newRecord);
      
      // Ordenar por puntuaci√≥n y mantener top 5
      records.sort((a, b) => b.score - a.score);
      records = records.slice(0, 5);
      
      localStorage.setItem(recordKey, JSON.stringify(records));
    }

    function getRecords(modalityKey) {
      const recordKey = `records_${modalityKey}`;
      return JSON.parse(localStorage.getItem(recordKey) || '[]');
    }

    function showRecords() {
      const modal = document.getElementById('recordsModal');
      const filter = document.getElementById('recordsFilter');
      filter.value = getModalityKey();
      updateRecordsDisplay();
      modal.style.display = 'flex';
    }

    function updateRecordsDisplay() {
      const modalityKey = document.getElementById('recordsFilter').value;
      const records = getRecords(modalityKey);
      const tbody = document.getElementById('recordsTableBody');
      
      tbody.innerHTML = '';
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay r√©cords a√∫n</td></tr>';
        return;
      }
      
      records.forEach((record, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${record.player}</td>
          <td>${record.score.toLocaleString()}</td>
          <td>${record.maxTiles}</td>
          <td>${record.date}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Cerrar modales
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Salir del juego
    function exitGame() {
      if (confirm('¬øEst√°s seguro de que quieres salir del juego?')) {
        window.close();
      }
    }

    // Precargar im√°genes
    function preloadImages() {
      return new Promise((resolve, reject) => {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'flex';
        loadingIndicator.style.alignItems = 'center';
        
        // Generar URLs para tema actual
        Object.assign(TILE_IMAGES, generateTileImages(currentTheme));
        
        const imagePromises = Object.values(TILE_IMAGES).map(url => {
          return new Promise((resolveImg, rejectImg) => {
            const img = new Image();
            img.onload = () => resolveImg(url);
            img.onerror = () => {
              console.warn(`‚ö†Ô∏è No se pudo cargar: ${url}`);
              resolveImg(url);
            };
            img.src = url;
          });
        });

        Promise.all(imagePromises)
          .then(() => {
            loadingIndicator.style.display = 'none';
            console.log('‚úÖ Recursos cargados correctamente');
            resolve();
          })
          .catch(error => {
            loadingIndicator.style.display = 'none';
            console.error('‚ùå Error cargando recursos:', error);
            resolve();
          });
      });
    }

    // Calcular tama√±o √≥ptimo del tablero
    function calculateOptimalBoardSize() {
      const gameArea = document.querySelector('.game-area');
      const availableWidth = window.innerWidth - 200; // Reservar espacio para controles
      const availableHeight = window.innerHeight - 300; // Reservar espacio para UI superior
      
      const maxTileSize = Math.min(
        Math.floor((availableWidth - 100) / boardSizeX) - 8,
        Math.floor((availableHeight - 100) / boardSizeY) - 8
      );
      
      return Math.max(50, Math.min(maxTileSize, 120));
    }

    // Inicializar tablero de juego
    function initBoard() {
      board = Array(boardSizeY).fill().map(() => Array(boardSizeX).fill(null));
      
      // Crear fichas iniciales con distribuci√≥n balanceada
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          const rand = Math.random();
          const randomLevel = rand < 0.7 ? 0 : rand < 0.9 ? 1 : 2;
          board[i][j] = { 
            level: randomLevel, 
            element: createTileElement(randomLevel, i, j) 
          };
        }
      }
      
      // Generar primera ficha siguiente
      nextTileLevel = generateNextTileLevel();
      
      renderBoard();
      updateNextTile();
      updateLevelPreview();
      updateLevelDisplay();
      updateStats();
      updateBonusButtons();
    }

    // Crear elemento de ficha
    function createTileElement(level, row, col) {
      const tile = document.createElement('div');
      tile.className = `tile level-${level}`;
      tile.dataset.row = row;
      tile.dataset.col = col;
      tile.dataset.level = level;
      
      // Crear texto del nivel
      const tileText = document.createElement('div');
      tileText.className = 'tile-text';
      if (!showNumbers) {
        tileText.classList.add('hidden');
      }
      tileText.textContent = level + 1;
      tile.appendChild(tileText);
      
      // Aplicar imagen de fondo
      const imageUrl = getTileImage(level);
      tile.style.backgroundImage = `url('${imageUrl}')`;
      
      // Calcular tama√±o √≥ptimo
      const tileSize = calculateOptimalBoardSize();
      tile.style.width = `${tileSize}px`;
      tile.style.height = `${tileSize}px`;
      tileText.style.fontSize = `${Math.max(12, tileSize * 0.2)}px`;
      
      // Eventos
      tile.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleTileClick(row, col);
      }, { passive: false });
      
      tile.addEventListener('click', (e) => {
        e.preventDefault();
        handleTileClick(row, col);
      });
      
      return tile;
    }

    // Actualizar ficha siguiente
    function updateNextTile() {
      const nextTileContainer = document.getElementById('nextTile');
      nextTileContainer.innerHTML = '';
      
      const tile = document.createElement('div');
      tile.className = 'next-tile';
      tile.textContent = showNumbers ? (nextTileLevel + 1) : '';
      tile.style.backgroundImage = `url('${getTileImage(nextTileLevel)}')`;
      
      nextTileContainer.appendChild(tile);
    }

    // Renderizar tablero completo
    function renderBoard() {
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      const tileSize = calculateOptimalBoardSize();
      gameBoard.style.gridTemplateColumns = `repeat(${boardSizeX}, ${tileSize}px)`;
      gameBoard.style.gridTemplateRows = `repeat(${boardSizeY}, ${tileSize}px)`;
      
      for (let i = 0; i < boardSizeY; i++) {
        for (let j = 0; j < boardSizeX; j++) {
          if (board[i][j] && board[i][j].element) {
            gameBoard.appendChild(board[i][j].element);
          }
        }
      }
    }

    // Manejar clic/toque en ficha
    function handleTileClick(row, col) {
      if (!board[row][col]) return;

      if (!selectedTile) {
        // Seleccionar ficha
        selectedTile = { row, col };
        board[row][col].element.classList.add('selected');
      } else {
        const { row: prevRow, col: prevCol } = selectedTile;
        board[prevRow][prevCol].element.classList.remove('selected');

        if (row === prevRow && col === prevCol) {
          // Deseleccionar la misma ficha
          selectedTile = null;
          return;
        }

        if (isAdjacent(row, col, prevRow, prevCol) && 
            board[row][col].level === board[prevRow][prevCol].level) {
          // Guardar estado antes del movimiento
          saveGameState();
          // Fusionar fichas
          mergeTiles(row, col, prevRow, prevCol);
        }
        
        selectedTile = null;
      }
    }

    // Verificar adyacencia
    function isAdjacent(row1, col1, row2, col2) {
      return (Math.abs(row1 - row2) === 1 && col1 === col2) || 
             (Math.abs(col1 - col2) === 1 && row1 === row2);
    }

    // Sistema de fusi√≥n con reglas especiales
    function mergeTiles(row, col, prevRow, prevCol) {
      const level = board[row][col].level;
      
      if (level >= maxLevel - 1) return;

      // Sistema de puntuaci√≥n exponencial
      const basePoints = Math.pow(2, level + 3) * 5;
      const levelBonus = (level + 1) * 15;
      const points = basePoints + levelBonus;
      score += points;

      // Crear nueva ficha fusionada
      const newLevel = level + 1;
      board[row][col] = { 
        level: newLevel, 
        element: createTileElement(newLevel, row, col) 
      };
      board[row][col].element.classList.add('merged');
      
      playSound('merge');

      // Determinar nivel de nueva ficha seg√∫n reglas especiales
      let newTileLevel;
      const rescueLevel = getOnlyTwoAdjacentPairs();
      
      if (rescueLevel === level) {
        // Regla 2: Fusi√≥n de rescate - nueva ficha ser√° del nivel fusionado + 1
        newTileLevel = level + 1;
        console.log(`Fusi√≥n de rescate activada: nivel ${level} ‚Üí nueva ficha nivel ${newTileLevel}`);
      } else {
        // Generaci√≥n normal
        newTileLevel = generateNextTileLevel();
      }

      // Colocar nueva ficha en posici√≥n vac√≠a
      board[prevRow][prevCol] = { 
        level: newTileLevel, 
        element: createTileElement(newTileLevel, prevRow, prevCol) 
      };

      // Generar siguiente ficha
      nextTileLevel = generateNextTileLevel();

      updateNextTile();
      renderBoard();
      updateStats();
      
      // Verificar condici√≥n de nivel m√°ximo (sin popup molesto)
      if (newLevel >= maxLevel - 1) {
        saveRecord();
        playSound('victory');
      }
    }

    // Actualizar estad√≠sticas en pantalla
    function updateStats() {
      document.getElementById('score').textContent = score.toLocaleString();
      document.getElementById('scoreSmall').textContent = score.toLocaleString();
      updateRecordInfo();
    }

    // Sistema de guardado de r√©cords
    function saveHighScore() {
      const modalityKey = getModalityKey();
      const currentHighKey = `gemafusion-highscore-${modalityKey}`;
      const currentHigh = parseInt(localStorage.getItem(currentHighKey) || '0');
      
      if (score > currentHigh) {
        localStorage.setItem(currentHighKey, score.toString());
        localStorage.setItem(`gemafusion-highscore-player-${modalityKey}`, playerNick);
        updateHighScoreDisplay();
      }
      
      saveRecord();
    }

    // Mostrar r√©cord actual
    function updateHighScoreDisplay() {
      const modalityKey = getModalityKey();
      const highScore = localStorage.getItem(`gemafusion-highscore-${modalityKey}`) || '0';
      document.getElementById('highScoreValue').textContent = parseInt(highScore).toLocaleString();
    }

    // Iniciar nueva partida
    async function startGame() {
      try {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'flex';
        
        // Configurar par√°metros del juego
        const gridType = document.getElementById('gridType').value;
        [boardSizeX, boardSizeY] = gridType.split('x').map(Number);
        maxLevel = parseInt(document.getElementById('maxLevel').value);
        playerNick = document.getElementById('playerNick').value.trim() || 'Jugador';
        currentTheme = document.getElementById('themeSelect').value;
        
        // Precargar recursos
        await preloadImages();
        
        // Resetear estado del juego
        score = 0;
        selectedTile = null;
        gameStartTime = Date.now();
        bonusesLeft = 3;
        undosLeft = 3;
        gameHistory = [];
        
        // Cambiar a pantalla de juego
        document.getElementById('optionsScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        
        // Reproducir sonido de bienvenida
        setTimeout(() => playSound('welcome'), 500);
        
        // Inicializar tablero
        initBoard();
        
        console.log(`üéÆ Nueva partida iniciada - ${boardSizeX}x${boardSizeY}, Nivel m√°ximo: ${maxLevel}, Jugador: ${playerNick}, Tema: ${currentTheme}`);
      } catch (error) {
        console.error('Error al iniciar el juego:', error);
        alert('‚ùå Error al inicializar el juego. Por favor, verifica tu conexi√≥n a internet e int√©ntalo de nuevo.');
      }
    }

    // Reiniciar juego
    function restartGame() {
      if (confirm('¬øEst√°s seguro de que quieres reiniciar la partida actual?')) {
        saveHighScore();
        startGame();
      }
    }

    // Volver al men√∫ principal
    function backToMenu() {
      if (confirm('¬øVolver al men√∫ principal? Se perder√° el progreso actual.')) {
        saveHighScore();
        document.getElementById('gameScreen').style.display = 'none';
        document.getElementById('optionsScreen').style.display = 'flex';
        updateHighScoreDisplay();
      }
    }

    // Inicializaci√≥n al cargar la p√°gina
    window.addEventListener('load', () => {
      console.log('üéÆ Gemafusion Enhanced cargado correctamente');
      updateHighScoreDisplay();
      
      // Configurar tema inicial
      Object.assign(TILE_IMAGES, generateTileImages(currentTheme));
      
      // Precargar im√°genes en segundo plano
      preloadImages().catch(error => {
        console.warn('Advertencia: Algunas im√°genes no se pudieron precargar:', error);
      });

      // Event listeners para modales
      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });
    });

    // Prevenir zoom en dispositivos m√≥viles
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });

    // Manejar cambios de orientaci√≥n y resize
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (document.getElementById('gameScreen').style.display !== 'none') {
          renderBoard();
          updateLevelPreview();
        }
      }, 100);
    });

    window.addEventListener('resize', debounce(() => {
      if (document.getElementById('gameScreen').style.display !== 'none') {
        renderBoard();
        updateLevelPreview();
      }
    }, 250));

    // Funci√≥n debounce
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Informaci√≥n del sistema de probabilidades
    console.log('üìä Sistemas implementados:');
    console.log('   ‚Ä¢ Generaci√≥n inteligente con probabilidades ponderadas');
    console.log('   ‚Ä¢ Regla de liberaci√≥n por mayor√≠a');
    console.log('   ‚Ä¢ Regla de fusi√≥n de rescate');
    console.log('   ‚Ä¢ UI optimizada para diferentes tama√±os de tablero');
  </script>
</body>
</html>